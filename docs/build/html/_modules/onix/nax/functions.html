

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>onix.nax.functions &mdash; ONIX Documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #0d0d0d" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releasenotes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pythonapi/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License Agreement</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ONIX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>onix.nax.functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for onix.nax.functions</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">onix.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">onix.data</span> <span class="k">as</span> <span class="nn">d</span>
<span class="kn">import</span> <span class="nn">math</span> <span class="k">as</span> <span class="nn">m</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">ScalarFormatter</span>
<span class="kn">import</span> <span class="nn">openmc</span>
<span class="kn">import</span> <span class="nn">itertools</span>


 <span class="c1"># This class stores the path of the simulation of the batch</span>
 <span class="c1"># and also extract corresponding cross sections</span>
<div class="viewcode-block" id="Batch"><a class="viewcode-back" href="../../../pythonapi/generated/onix.nax.functions.Batch.html#onix.nax.Batch">[docs]</a><span class="k">class</span> <span class="nc">Batch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Batch objects store neutronics data from a coupled simulation modelling the irradiation of a fuel batch.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str</span>
<span class="sd">        Path to a simulation&#39;s directory </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_output</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span><span class="s1">&#39;/output_summary&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the path of the simulation&#39;s directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the path of the simulation&#39;s output summary directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_output</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ng_xs_seq_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionnary where keys are nuclides names and entries are one-group (n,gamma) cross sections evolution during the fuel batch exposition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ng_xs_seq_dict</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tot_xs_seq_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionnary where keys are nuclides names and entries are one-group total absorption cross sections evolution during the fuel batch exposition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tot_xs_seq_dict</span>

    <span class="c1"># Reads the n,gamma and total abs xs for nuclide list in cell</span>
<div class="viewcode-block" id="Batch.read_nuclide_list_xs"><a class="viewcode-back" href="../../../pythonapi/generated/onix.nax.functions.Batch.html#onix.nax.Batch.read_nuclide_list_xs">[docs]</a>    <span class="k">def</span> <span class="nf">read_nuclide_list_xs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nuclide_list</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads (n,gamma) and total absorption one-group cross sections evolution from coupled simulation&#39;s output for a given list of nuclides and for a given BUCell. This data is stored in cross section dictionnaries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nuclide_list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ng_xs_seq_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tot_xs_seq_dict</span><span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">nuclide</span> <span class="ow">in</span> <span class="n">nuclide_list</span><span class="p">:</span>
            <span class="c1">#print (self.path)</span>
            <span class="n">ng_xs_seq_dict</span><span class="p">[</span><span class="n">nuclide</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_xs_seq</span><span class="p">(</span><span class="n">nuclide</span><span class="p">,</span> <span class="s1">&#39;(n,gamma)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
            <span class="n">tot_xs_seq_dict</span><span class="p">[</span><span class="n">nuclide</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_tot_xs</span><span class="p">(</span><span class="n">nuclide</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ng_xs_seq_dict</span> <span class="o">=</span>  <span class="n">ng_xs_seq_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tot_xs_seq_dict</span> <span class="o">=</span>  <span class="n">tot_xs_seq_dict</span></div></div>


<span class="c1"># This function go over NAX nucl list and list the chain of isotopes connected through (n,gamma) reactions</span>
<span class="c1"># It builds a dict when each key is the z number and entry is list of tuble with first element nuclide name, second element natural abundance</span>
<span class="c1"># This function does not take into account if ngamma cross sections are non-zero (this might reduce chain)</span>
<span class="c1"># In addition, this function will remove single nuclides and nuclide at start of chains and which have zero abundance</span>

<span class="c1"># This function is probably obsolete. Might consider removing it.</span>
<span class="k">def</span> <span class="nf">list_NAX_ng_chain</span><span class="p">():</span>

    <span class="n">NAX_nucl_list</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">NAX_nucl_list</span>

    <span class="n">z_chain_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">zamid</span> <span class="ow">in</span> <span class="n">NAX_nucl_list</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_zamid_z</span><span class="p">(</span><span class="n">zamid</span><span class="p">)</span>
        <span class="n">name_old_format</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">zamid_to_name</span><span class="p">(</span><span class="n">zamid</span><span class="p">)</span>
        <span class="n">name_new_format</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">onix_name_to_openmc_name</span><span class="p">(</span><span class="n">name_old_format</span><span class="p">)</span>
        <span class="n">nat_abun</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_zamid_natural_abundance</span><span class="p">(</span><span class="n">zamid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">z</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">z_chain_dict</span><span class="p">:</span>
            <span class="c1"># If nuclide is first AND has zero abun, the code does not add it to the dict</span>
            <span class="k">if</span> <span class="n">nat_abun</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_chain_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name_new_format</span><span class="p">,</span><span class="n">nat_abun</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_chain_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name_new_format</span><span class="p">,</span><span class="n">nat_abun</span><span class="p">))</span>

    <span class="c1"># Remove single nuclide</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">z_chain_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_chain_dict</span><span class="p">[</span><span class="n">z</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">z_chain_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">z_chain_dict</span>





<div class="viewcode-block" id="review_all_ratio_candidates"><a class="viewcode-back" href="../../../pythonapi/generated/onix.nax.review_all_ratio_candidates.html#onix.nax.review_all_ratio_candidates">[docs]</a><span class="k">def</span> <span class="nf">review_all_ratio_candidates</span><span class="p">(</span><span class="n">NAX_cell</span><span class="p">,</span> <span class="n">operation_history</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">ratio_uncertainty</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This function plots a series of graphs containing isotopic ratios evolution and their associated relative errors on fluence for a given operation history. It can be used to identify potential good fluence indicators.</span>

<span class="sd">    **Detail description**: the function builds (n,gamma) chains from all isotopes which are available in the one-group cross section library with onix.nax.list_NAX_ng_chain_from_output. Then, it depletes each chain with a simple and fast analytical integrator (based on Bateman solution) according to the operation history provided. The obtained isotopic evolutions are used to construct ratios evolution as well as relative error on fluence associated with these ratios. Both ratios evolution and relative errors on fluence are displayed on graphs for the user to assess good fluence indicators.</span>

<span class="sd">    **Note**: Since the relative error on fluence depends on the relative error on the measured ratios, the user must provide an assumed relative error that affect ratios measurements. These uncertainties affecting measurements depend on the isotopes densities, the ratio values and the technology used to measure the ratios. ONIX makes the approximation that the uncertainties affecting all ratios are the same.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NAX_cell: str</span>
<span class="sd">        Name of the BUCell for which fluence indicators are to be identified</span>
<span class="sd">    operation_history: List of Tuples</span>
<span class="sd">        Irradiation history of the reactor. This history can include successive fuel batches of different types. Each tuples represent the operation of a batch. The first element of the Tuple is the Batch object (onix.nax.Batch) corresponding to the batch type and the second element is the number of days for which this fuel batch has been run.</span>
<span class="sd">    path: str</span>
<span class="sd">        Path to the simulation&#39;s directory</span>
<span class="sd">    ratio_uncertainty: float</span>
<span class="sd">        Assumed uncertainty on the measured ratios provided by the user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chain_dict</span> <span class="o">=</span> <span class="n">list_NAX_ng_chain_from_output</span><span class="p">(</span><span class="n">path</span> <span class="p">,</span><span class="n">NAX_cell</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">chain_dict</span><span class="p">:</span>
        <span class="c1"># if key != 68:</span>
        <span class="c1">#   continue</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1"> chain dict</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">chain_dict</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># It seems that list_NAX_ng_chain_from_output finds that there are only one chain per element</span>
        <span class="c1"># Hence taking only the first element of the list of chains</span>
        <span class="c1"># This is not satisfactory but will do for the moment</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">chain_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">init_abun</span> <span class="o">=</span> <span class="n">get_nat_abun_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

        <span class="n">history_matrix_list</span> <span class="o">=</span> <span class="n">get_history_matrix_list</span><span class="p">(</span><span class="n">operation_history</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">)</span>
        <span class="n">step_break_indexes</span> <span class="o">=</span> <span class="n">locate_step_break</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">locate_batch_break_end_start</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">combine_indexes</span> <span class="o">=</span> <span class="n">get_combine_indexes</span><span class="p">(</span><span class="n">step_break_indexes</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="p">)</span>

        <span class="n">history_matrix</span> <span class="o">=</span> <span class="n">concatenate_history_matrix</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">history_fluence</span> <span class="o">=</span> <span class="n">concatenate_history_fluence</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="n">get_ratio_evolution</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">)</span>

        <span class="n">ratio_derivative_dict</span> <span class="o">=</span> <span class="n">get_ratio_derivative_dict</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="p">,</span> <span class="n">step_break_indexes</span><span class="p">)</span>
        <span class="n">fluence_derivative_dict</span> <span class="o">=</span> <span class="n">get_fluence_derivative_dict</span><span class="p">(</span><span class="n">ratio_derivative_dict</span><span class="p">)</span>
        <span class="n">history_mid_fluence</span> <span class="o">=</span> <span class="n">get_history_mid_fluence</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">step_break_indexes</span><span class="p">)</span>

        <span class="n">plot_fluence_relative_error_with_ratio_history</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">fluence_derivative_dict</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">,</span> <span class="n">combine_indexes</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">ratio_uncertainty</span><span class="p">)</span></div>
        <span class="c1"># plot_ng_chain_densities_history(chain, history_matrix, history_fluence, &#39;no&#39;)</span>
        <span class="c1"># plot_ng_chain_ratio_history(chain, ratio_evolution, history_fluence)</span>
        <span class="c1"># plot_chain_fluence_relative_error_history(ratio_evolution, fluence_derivative_dict, history_mid_fluence, combine_indexes)</span>
        <span class="c1"># plot_ng_chain_ratio_derivative_history(ratio_evolution, ratio_derivative_dict, history_mid_fluence, combine_indexes)</span>


<div class="viewcode-block" id="review_selected_ratio_candidates"><a class="viewcode-back" href="../../../pythonapi/generated/onix.nax.review_selected_ratio_candidates.html#onix.nax.review_selected_ratio_candidates">[docs]</a><span class="k">def</span> <span class="nf">review_selected_ratio_candidates</span><span class="p">(</span><span class="n">NAX_cell</span><span class="p">,</span> <span class="n">operation_history</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">selected_list</span><span class="p">,</span> <span class="n">ratio_uncertainty</span><span class="p">,</span> <span class="n">cut_off</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This function plots a series of graphs containing isotopic ratios evolution and their associated relative errors on fluence for a selected list of provided ratios  and for a given operation history. It can be used to identify potential good fluence indicators.</span>

<span class="sd">    **Detail description**: the function builds (n,gamma) chains from all isotopes which are available in the one-group cross section library with onix.nax.list_NAX_ng_chain_from_output. Then, it depletes chains which contain the selected ratios provided by the user with a simple and fast analytical integrator (based on Bateman solution) according to the operation history provided. The obtained isotopic evolutions are used to construct ratios evolution as well as relative error on fluence associated with these ratios. Both ratios evolution and relative errors on fluence are displayed on graphs for the user to assess good fluence indicators.</span>

<span class="sd">    **Note**: Since the relative error on fluence depends on the relative error on the measured ratios, the user must provide an assumed relative error that affect ratios measurements. These uncertainties affecting measurements depend on the isotopes densities, the ratio values and the technology used to measure the ratios. ONIX makes the approximation that the uncertainties affecting all ratios are the same.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NAX_cell: str</span>
<span class="sd">        Name of the BUCell for which fluence indicators are to be identified</span>
<span class="sd">    operation_history: List of Tuples</span>
<span class="sd">        Irradiation history of the reactor. This history can include successive fuel batches of different types. Each tuples represent the operation of a batch. The first element of the Tuple is the Batch object (onix.nax.Batch) corresponding to the batch type and the second element is the number of days for which this fuel batch has been run.</span>
<span class="sd">    path: str</span>
<span class="sd">        Path to the simulation&#39;s directory</span>
<span class="sd">    selected_list: List of str</span>
<span class="sd">        List of nuclide&#39;s names selected by the user</span>
<span class="sd">    ratio_uncertainty: float</span>
<span class="sd">        Assumed uncertainty on the measured ratios provided by the user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chain_dict</span> <span class="o">=</span> <span class="n">list_NAX_ng_chain_from_output</span><span class="p">(</span><span class="n">path</span> <span class="p">,</span><span class="n">NAX_cell</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">selected_fluence_derivative_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">selected_ratio_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">selected_duo_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">z_to_name_dict</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">nuc_zz_dic</span>

    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">chain_dict</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">z_to_name_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>

        <span class="n">skip</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">selected_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ratio</span><span class="p">:</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>

        <span class="k">if</span> <span class="n">skip</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="k">continue</span>


        <span class="n">chain</span> <span class="o">=</span> <span class="n">chain_dict</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">init_abun</span> <span class="o">=</span> <span class="n">get_nat_abun_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

        <span class="n">history_matrix_list</span> <span class="o">=</span> <span class="n">get_history_matrix_list</span><span class="p">(</span><span class="n">operation_history</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">)</span>
        <span class="n">step_break_indexes</span> <span class="o">=</span> <span class="n">locate_step_break</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">locate_batch_break_end_start</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">batch_break_indexes2</span> <span class="o">=</span> <span class="n">locate_batch_break</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">combine_indexes</span> <span class="o">=</span> <span class="n">get_combine_indexes</span><span class="p">(</span><span class="n">step_break_indexes</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="p">)</span>

        <span class="n">history_matrix</span> <span class="o">=</span> <span class="n">concatenate_history_matrix</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">history_fluence</span> <span class="o">=</span> <span class="n">concatenate_history_fluence</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">)</span>
        <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="n">get_ratio_evolution</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">)</span>
        <span class="n">duo_evolution</span> <span class="o">=</span> <span class="n">get_duo_evolution</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">)</span>

        <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)</span>
        <span class="n">ratios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">selected_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratio_name_list</span><span class="p">:</span>
                <span class="n">ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ratios</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">continue</span>

        <span class="c1"># To get data for ploting ratio vs plutonium</span>
        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
            <span class="c1"># if ratio == &#39;B-11/B-10&#39;:</span>
            <span class="c1">#     print (ratio)</span>
            <span class="c1">#     print (ratio_evolution[0][ratio])</span>
            <span class="c1">#     #print (history_fluence)</span>
            <span class="c1"># if ratio == &#39;Sm-149/Sm-148&#39;:</span>
            <span class="c1">#     print (ratio)</span>
            <span class="c1">#     print (ratio_evolution[0][ratio])</span>
            <span class="c1">#     #print (history_fluence)</span>
            <span class="c1"># if ratio == &#39;Sm-148/Sm-147&#39;:</span>
            <span class="c1">#     print (ratio)</span>
            <span class="c1">#     print (ratio_evolution[0][ratio])</span>
            <span class="c1"># if ratio == &#39;Dy-164/Dy-163&#39;:</span>
            <span class="c1">#     print (ratio)</span>
            <span class="c1">#     print (ratio_evolution[0][ratio])</span>
            <span class="c1">#     print (&#39;fluence_seq&#39;,history_fluence)</span>

            <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="s1">&#39;Gd-158/Gd-157&#39;</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ratio</span><span class="p">])</span>
                <span class="c1">#print (history_fluence)</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="s1">&#39;Sm-149/Sm-148&#39;</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ratio</span><span class="p">])</span>
                <span class="c1">#print (history_fluence)</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="s1">&#39;Cd-114/Cd-113&#39;</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ratio</span><span class="p">])</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;fluence_seq&#39;</span><span class="p">,</span><span class="n">history_fluence</span><span class="p">)</span>

        <span class="n">ratio_derivative_dict</span> <span class="o">=</span> <span class="n">get_ratio_derivative_dict</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="p">,</span> <span class="n">step_break_indexes</span><span class="p">)</span>
        <span class="n">fluence_derivative_dict</span> <span class="o">=</span> <span class="n">get_fluence_derivative_dict</span><span class="p">(</span><span class="n">ratio_derivative_dict</span><span class="p">)</span>
        <span class="n">history_mid_fluence</span> <span class="o">=</span> <span class="n">get_history_mid_fluence</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">step_break_indexes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">:</span>
            <span class="n">selected_fluence_derivative_dict</span><span class="p">[</span><span class="n">ratio</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluence_derivative_dict</span><span class="p">[</span><span class="n">ratio</span><span class="p">]</span>
            <span class="n">selected_ratio_dict</span><span class="p">[</span><span class="n">ratio</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ratio</span><span class="p">]</span>
            <span class="n">selected_duo_dict</span><span class="p">[</span><span class="n">ratio</span><span class="p">]</span> <span class="o">=</span> <span class="n">duo_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ratio</span><span class="p">]</span>

    <span class="c1">#quit()</span>

    <span class="n">plot_selected_ratio_history</span><span class="p">(</span><span class="n">selected_list</span><span class="p">,</span> <span class="n">selected_ratio_dict</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">batch_break_indexes2</span><span class="p">,</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">invert</span><span class="p">)</span>
    <span class="c1"># plot_selected_ratio_history_sup1(selected_list, selected_ratio_dict, history_fluence, batch_break_indexes = batch_break_indexes2)</span>

    <span class="n">plot_selected_duo_history</span><span class="p">(</span><span class="n">selected_list</span><span class="p">,</span> <span class="n">selected_duo_dict</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">batch_break_indexes2</span><span class="p">)</span>

    <span class="n">plot_selected_fluence_relative_error_history</span><span class="p">(</span><span class="n">selected_list</span><span class="p">,</span> <span class="n">selected_ratio_dict</span><span class="p">,</span> <span class="n">selected_fluence_derivative_dict</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">,</span> <span class="n">combine_indexes</span><span class="p">,</span> <span class="n">ratio_uncertainty</span><span class="p">,</span> <span class="n">cut_off</span> <span class="o">=</span> <span class="n">cut_off</span><span class="p">,</span> <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">batch_break_indexes2</span><span class="p">)</span></div>
        <span class="c1">#plot_fluence_relative_error_with_ratio_history(ratio_evolution, fluence_derivative_dict, history_mid_fluence, combine_indexes, chain, history_matrix, history_fluence)</span>
    <span class="c1">#plot_ng_chain_densities_history(chain, history_matrix, history_fluence, &#39;no&#39;)</span>
    <span class="c1">#plot_selected_ratio_history(selected_list, selected_ratio_dict, history_fluence)</span>
        <span class="c1"># plot_selected_fluence_relative_error_history(ratio_evolution, fluence_derivative_dict, history_mid_fluence, combine_indexes)</span>
        <span class="c1"># plot_ng_chain_ratio_derivative_history(ratio_evolution, ratio_derivative_dict, history_mid_fluence, combine_indexes)</span>


<div class="viewcode-block" id="plot_pu_prod"><a class="viewcode-back" href="../../../pythonapi/generated/onix.nax.plot_pu_prod.html#onix.nax.plot_pu_prod">[docs]</a><span class="k">def</span> <span class="nf">plot_pu_prod</span><span class="p">(</span><span class="n">fuel_cell</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">,</span> <span class="n">operation_history</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">scale_up_factor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This function plots the plutonium production in a reactor against fluence measured in a specified NAX BUCell (typically, a region where fluence indicators are measured) and according to a provided operation history.</span>

<span class="sd">    **Detail description**: The function goes over the density output of all the batches&#39; simulation that constitute the operation history and extracts the plutonium evolution. Likewise, it extracts the fluence evolution for each batches in the NAX BUCell (the BUCell where fluence indicators are measured). It then constructs a plutonium evolution history against fluence according to the operation history provided. Finally, the function scales up the plutonium production to the entire reactor using the provided scale_up_factor. Graphs of plutonium evolution are displayed where each batch refueling is indicated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fuel_cell: str</span>
<span class="sd">        Name of the BUCell where plutonium is produced</span>
<span class="sd">    NAX_cell: str</span>
<span class="sd">        Name of the BUCell where fluence indicators are measured</span>
<span class="sd">    operation_history: List of Tuples</span>
<span class="sd">        Irradiation history of the reactor. This history can include successive fuel batches of different types. Each tuples represent the operation of a batch. The first element of the Tuple is the Batch object (onix.nax.Batch) corresponding to the batch type and the second element is the number of days for which this fuel batch has been run.</span>
<span class="sd">    path: str</span>
<span class="sd">        Path to the simulation&#39;s directory</span>
<span class="sd">    scale_up_factor: float</span>
<span class="sd">        Factor to be used to scale up the plutonium production from the simulation&#39;s system (a pin-cell or an assembly for instance) to the whole reactor.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pu_prod_history_matrix_list</span> <span class="o">=</span> <span class="n">get_pu_prod_history_matrix_list</span><span class="p">(</span><span class="n">operation_history</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">)</span>
    <span class="n">concatenated_pu_prod_history_matrix</span> <span class="o">=</span> <span class="n">concatenate_pu_prod_history_matrix</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">)</span>
    <span class="n">concatenated_pu_cum_prod_history_matrix</span> <span class="o">=</span> <span class="n">concatenate_pu_cum_prod_history_matrix</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">)</span>

    <span class="n">concatenated_history_fluence</span> <span class="o">=</span> <span class="n">concatenate_history_fluence_from_pu_prod_matrix_list</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">)</span>
    <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">locate_batch_break_from_pu_prod_matrix_list</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">)</span>

    <span class="n">mass_pu_prod_history_matrix</span> <span class="o">=</span> <span class="n">convert_density_to_mass</span><span class="p">(</span><span class="n">concatenated_pu_prod_history_matrix</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">scale_up_factor</span> <span class="o">=</span> <span class="n">scale_up_factor</span><span class="p">)</span>
    <span class="n">mass_pu_cum_prod_history_matrix</span> <span class="o">=</span> <span class="n">convert_density_to_mass</span><span class="p">(</span><span class="n">concatenated_pu_cum_prod_history_matrix</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">scale_up_factor</span> <span class="o">=</span> <span class="n">scale_up_factor</span><span class="p">)</span>

    <span class="n">plot_mass_pu_prod_against_fluence</span><span class="p">(</span><span class="n">mass_pu_prod_history_matrix</span><span class="p">,</span> <span class="n">concatenated_history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">batch_break_indexes</span><span class="p">)</span>
    <span class="n">plot_mass_pu_cum_prod_against_fluence</span><span class="p">(</span><span class="n">mass_pu_cum_prod_history_matrix</span><span class="p">,</span> <span class="n">concatenated_history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="n">batch_break_indexes</span><span class="p">)</span></div>


<span class="c1"># The fact that it depends on step is troulbesome</span>
<span class="c1"># If the xs of a nuclide is non-zero initially, I dont think it is possible that it just goes to zero during the operation</span>
<div class="viewcode-block" id="list_NAX_ng_chain_from_output"><a class="viewcode-back" href="../../../pythonapi/generated/onix.nax.list_NAX_ng_chain_from_output.html#onix.nax.list_NAX_ng_chain_from_output">[docs]</a><span class="k">def</span> <span class="nf">list_NAX_ng_chain_from_output</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This function builds chains of nuclides connected via (n,gamma) reactions. These chains will be used to find the best isotopic ratios for fluence estimations.</span>

<span class="sd">    **Detail description**: The function builds dictionnaries where keys are atomic number (z) and entries are list of (n,gamma) chains (there can be multiple chains per z number). The elements in the list are tuples where the first element is the name of the nuclide and the second element is its natural abundance. The way chains are constructed is as follows:</span>
<span class="sd">        - The algorithm gathers all isotopes of same z which have data in the one-group cross section library of the simulation (nuclides with no cross section data are not considered)</span>
<span class="sd">        - Then it removes all isotopes which comes before the first naturally occuring isotopes (in the (n,gamma) chain order)</span>
<span class="sd">        - Then it removes all isotopes which are not produced by their (n,gamma) precursor in the (n,gamma) chain</span>
<span class="sd">        - Then it removes all isotopes which have half life smaller than 10,000 years (changes due to decay should be negligible compared to changes due to (n,gamma) reactions)</span>

<span class="sd">    **Note 1**: Isotopes from a (n,gamma) chain which are produced by other neutron-induced reactions at a rate similar or higher than the (n,gamma) reaction should also be removed. However, since the production rate depends not only on the one-group cross section but also on the density of the precursor, it requires knowing the actual density of the elements present in the material studied. The objective of the NAX module is to identify potential good fluence indicators among all possible isotopes without knowing the actual isotopics of the material studied. Therefore, this criteria is not implemented in the NAX module.</span>

<span class="sd">    **Note 2**: All isotopes tested are assumed to be present in the material according to their natural abundance. Absolute density of each element (families of isotopes) does not play a role here as ratios are taken between isotopes of the same elements.</span>

<span class="sd">    **Note 3**: In the current version, the user needs to specify a macrostep which will be used by the code to verify the values of the one-group (n,gamma) cross sections. It is reasonably assumed that if a nuclide&#39;s one-group cross section is non-zero at a specific macrostep, it is non-zero all along the simulation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str</span>
<span class="sd">        Path to a simulation&#39;s directory</span>
<span class="sd">    cell: str</span>
<span class="sd">        Name of the BUCell to be studied</span>
<span class="sd">    step: int</span>
<span class="sd">        Macrostep at which tests on one-group (n,gamma) cross section are to be done</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#This function will build dict (entries are z) of list (one list per chain, there can be multiple chain per z if ng xs is zero/decay too big/produced by other element somewhere and breaks chain)</span>
<span class="c1"># of tuples (first element is name and second elt is nat abun)</span>
<span class="c1"># It is build from passlist (which will have cross sections) and the NAX_z_list</span>

<span class="c1"># First the algorithm gather all isotopes of z existing from output xs lib (nuclides with no xs are not considered)</span>
<span class="c1"># Then it eliminates all those which are before the first naturally occuring isotope</span>
<span class="c1"># Then it eliminates those which have decay greater than threshold</span>
<span class="c1"># Then eliminates those which are not produced by ng of precursor</span>
<span class="c1"># Then eliminates those for which another reaction than ng from another element produced them at a rate that is bigger than 1E-3 of the ng production rate</span>
<span class="c1"># Verification that depends on cross section are repeated at each new step</span>
<span class="c1"># All nuclides used in ratio must either be directly linked through other valid isotopes or linked through a chain of valid isotopes</span>
<span class="c1"># If one isotopes is linked through other via an invalid isotope, then it should be removed</span>

<span class="c1"># Remark: both the criteria that nuclide needs to be produced by non-zero ng by precursor and criteria that</span>
<span class="c1"># ng rate must be 1000 bigger than next production rate can be done by looking reac rate.</span>


    <span class="n">NAX_z_list</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">NAX_z_list</span>
    <span class="n">z_chain_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># This method should detect which decay lib was used in the run</span>
    <span class="c1"># This is not impplemented yet and here ENDFVIII decay is set</span>
    <span class="c1">#decay_path =&#39;/home/julien/Open-Burnup.dev/onix/data/other_libs/ENDFVIII/decay_lib&#39;</span>
    <span class="c1">#decay_dict = d.read_decay_lib(decay_path)</span>
    <span class="n">decay_dict</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">default_decay_lib_b</span>

    <span class="n">xs_lib_nucl_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_xs_nucl</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>

    <span class="c1"># This part list the nuclides with z that exist in the xs lib and create lists of chain starting with the first non-zero isotopes</span>
    <span class="c1"># It also remove nuclide with decay constant that are too big</span>

    <span class="n">z_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">NAX_z_list</span><span class="p">:</span>

        <span class="n">new_chain</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="n">z_chains</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#Only takes nuclide which have cross section</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">xs_lib_nucl_list</span><span class="p">:</span>
            <span class="n">zamid</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">name_to_zamid</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">nucl_z</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_name_z</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nucl_z</span> <span class="o">==</span> <span class="n">z</span><span class="p">:</span>

                <span class="c1"># Eliminate nuclide with half-life smaller than 10,000 years</span>
                <span class="c1"># This create a hole and thus a new chain</span>
                <span class="k">if</span> <span class="n">zamid</span> <span class="ow">in</span> <span class="n">decay_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;total decay&#39;</span> <span class="ow">in</span> <span class="n">decay_dict</span><span class="p">[</span><span class="n">zamid</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">decay_dict</span><span class="p">[</span><span class="n">zamid</span><span class="p">][</span><span class="s1">&#39;total decay&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.2e-12</span><span class="p">:</span>
                            <span class="n">new_chain</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                            <span class="k">continue</span>

                <span class="c1"># Eliminate isomeric state, it creates non linear chains</span>
                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_zamid_s</span><span class="p">(</span><span class="n">zamid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">nucl_nat_abun</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_name_natural_abundance</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c1">#if z not in z_chain_dict:</span>
                <span class="c1">#if z not in z_list:</span>
                <span class="k">if</span> <span class="n">new_chain</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>

                    <span class="c1"># This guy is candidate to be first nuclide in chain</span>

                    <span class="c1"># Here we test if its ng cross section is non-zero for step</span>
                    <span class="c1">#path_to_xs = path_to_output+&#39;/{}_xs_lib&#39;.format(cell)</span>
                    <span class="n">nucl_ng_seq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_xs_seq</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;(n,gamma)&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
                    <span class="n">step_ng</span> <span class="o">=</span> <span class="n">nucl_ng_seq</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>

                    <span class="c1"># If this isotope has a zero ng xs, it can&#39;t be first nuclide in chain</span>
                    <span class="k">if</span> <span class="n">step_ng</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># If this isotope has zero natural abundance, it can&#39;t be the first nuclide in chain</span>
                    <span class="k">elif</span> <span class="n">nucl_nat_abun</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#z_chain = [(name, nucl_nat_abun)]</span>
                        <span class="n">z_chains</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">name</span><span class="p">,</span> <span class="n">nucl_nat_abun</span><span class="p">)])</span>
                        <span class="n">z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                        <span class="n">new_chain</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
                        <span class="c1">#z_chain_dict[z] = [(name, nucl_nat_abun)]</span>
                <span class="k">elif</span> <span class="n">new_chain</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>

                    <span class="c1"># This guy is candidate to be in the chain somewhere (but not as first)</span>

                    <span class="c1"># There is an important subtlety here.</span>
                    <span class="c1"># You want to remove a nuclide from the chain if it is produced significantly by another process than ng</span>
                    <span class="c1"># This depends obviously on all the precursors density in the system (if the wrong precursors is way larger than the ng precusros for example)</span>
                    <span class="c1"># However, this would only be doable when you know the initial density of your material or when you do an actual NAX work on a material you know the impurities in</span>
                    <span class="c1"># WWhat we would like to do is comparing multiple ratio usefulness without any information on the density situation of the material (when you want to </span>
                    <span class="c1"># compare all nuclides, what density should you put in the material? The default 1E-22? Their natural abundance? A real case application will never </span>
                    <span class="c1"># be like that)</span>
                    <span class="c1"># I could compare cross section instead of reaction rate. But when undertaking theoritical evaluation of ratio usefulness, I dont think looking at xs relative magnitude is relevant</span>
                    <span class="c1"># Beause in the practical case, the magnitude of the rate might not be the same as xs</span>
                    <span class="c1"># I thus propose not to discard nuclide on the basis on the relative cross section of their precursor</span>

                    <span class="c1"># It is at least necessary to verify that ng precursor has non-zero cross section for ng</span>
            
                    <span class="c1"># prod_rank = utils.read_nuclide_reac_rank(name, step+1, path_to_output+&#39;/cell_2_reacs_rank&#39;)[1]</span>
                    <span class="n">ng_precursor_zamid</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_zamid_precursor</span><span class="p">(</span><span class="n">zamid</span><span class="p">,</span> <span class="s1">&#39;(n,gamma)&#39;</span><span class="p">)</span>
                    <span class="n">ng_precursor_name</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">zamid_to_name</span><span class="p">(</span><span class="n">ng_precursor_zamid</span><span class="p">)</span>

                    <span class="c1"># If ng precursor is not in xs lib, remove nuclide</span>
                    <span class="c1"># This create a hole and thus a new chain</span>
                    <span class="k">if</span> <span class="n">ng_precursor_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xs_lib_nucl_list</span><span class="p">:</span>
                        <span class="n">new_chain</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                        <span class="k">continue</span>


                    <span class="n">precursor_xs_seq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_xs_seq</span><span class="p">(</span><span class="n">ng_precursor_name</span><span class="p">,</span><span class="s1">&#39;(n,gamma)&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
                    <span class="n">precursor_step_xs</span> <span class="o">=</span> <span class="n">precursor_xs_seq</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
                    <span class="c1"># If ng precursor has 0 ng xs, remove nuclide</span>
                    <span class="c1"># This create a hole and thus a new chain</span>
                    <span class="k">if</span> <span class="n">precursor_step_xs</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">new_chain</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                        <span class="k">continue</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">z_chains</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">nucl_nat_abun</span><span class="p">))</span>

        <span class="c1"># This part remove isolated nuclide</span>
        <span class="n">z_chains_no_single</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">z_chains</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># for chain in z_chains:</span>
        <span class="c1">#   if len(chain) == 1:</span>
        <span class="c1">#       print (chain)</span>
        <span class="c1">#       z_chains.remove(chain)</span>

        <span class="c1"># Certain z chains will be just empty ([]) because all chains were single chains</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_chains_no_single</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">z_chain_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_chains_no_single</span>

    <span class="c1"># The chain dict obtain will contain holes</span>
    <span class="c1"># If a nuclide is isolated at the beginning or at the end of the chain, it can be removed</span>
    <span class="c1"># However, when removing a nuclide that is isolated at the beginning, the code must be careful that the</span>
    <span class="c1"># chain lead has to have abundance non zero</span>
    <span class="c1">#Otherwise, if the chain has hole in its middle, the code has to divide chain in severail subchains, again, making sure that</span>
    <span class="c1"># each chain lead has non-zero abundance</span>

    <span class="k">return</span> <span class="n">z_chain_dict</span></div>

<span class="k">def</span> <span class="nf">get_chain_nuclide_index</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">nuclide</span><span class="p">):</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nuclide</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">index</span>

<span class="k">def</span> <span class="nf">get_chain_nuclide_nat_abun</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">nuclide</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nuclide</span><span class="p">:</span>
            <span class="n">nat_abun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">nat_abun</span>

<span class="k">def</span> <span class="nf">get_chain_nuclide_name</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">name</span>

<span class="k">def</span> <span class="nf">get_nat_abun_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>

    <span class="n">nat_abun_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="n">nat_abun_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">nat_abun_list</span>

<span class="k">def</span> <span class="nf">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>

    <span class="n">nuclide_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="n">nuclide_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">nuclide_list</span>


<span class="k">def</span> <span class="nf">bateman_term</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">init_abun</span><span class="p">,</span> <span class="n">nuclide</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">fluence</span><span class="p">,</span> <span class="n">ng_xs_seq_dict</span><span class="p">,</span> <span class="n">tot_xs_seq_dict</span><span class="p">):</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">get_chain_nuclide_index</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">nuclide</span><span class="p">)</span>
    <span class="c1">#nat_abun = get_chain_nuclide_nat_abun(chain, nuclide)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">j_name</span> <span class="o">=</span> <span class="n">get_chain_nuclide_name</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

        <span class="n">j_tot_xs</span> <span class="o">=</span> <span class="n">tot_xs_seq_dict</span><span class="p">[</span><span class="n">j_name</span><span class="p">][</span><span class="n">step</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">k_name</span> <span class="o">=</span> <span class="n">get_chain_nuclide_name</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">k_ng_xs</span> <span class="o">=</span> <span class="n">ng_xs_seq_dict</span><span class="p">[</span><span class="n">k_name</span><span class="p">][</span><span class="n">step</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">*=</span> <span class="n">k_ng_xs</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">k_tot_xs</span> <span class="o">=</span> <span class="n">tot_xs_seq_dict</span><span class="p">[</span><span class="n">k_name</span><span class="p">][</span><span class="n">step</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">/=</span> <span class="p">(</span><span class="n">k_tot_xs</span> <span class="o">-</span> <span class="n">j_tot_xs</span><span class="p">)</span>
        <span class="c1"># print(f, f*N0)</span>
        <span class="c1"># While in the coefficient, we can keep xs  in barn unit (coefficients are unit-less), we need to convert xs to cm unit in the exp</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">init_abun</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">j_tot_xs</span><span class="o">*</span><span class="mf">1E-24</span><span class="o">*</span><span class="n">fluence</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="c1"># This build the Bateman solution for a specific step (with specific xs values) for a specific nuclide</span>
<span class="k">def</span> <span class="nf">bateman_step_solution</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">init_abun_list</span><span class="p">,</span> <span class="n">nuclide</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">fluence</span><span class="p">,</span> <span class="n">ng_xs_seq_dict</span><span class="p">,</span> <span class="n">tot_xs_seq_dict</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">get_chain_nuclide_index</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">nuclide</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">res</span> <span class="o">+=</span> <span class="n">bateman_term</span><span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">j</span><span class="p">:],</span> <span class="n">init_abun_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">nuclide</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">fluence</span><span class="p">,</span> <span class="n">ng_xs_seq_dict</span><span class="p">,</span> <span class="n">tot_xs_seq_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="c1"># This funtion builds a matrix of bateman step solution where:</span>
<span class="c1"># Each line corresponds to one isotope ratio, each element of the line is a list of data generated by the Bateman step solutions for step s with </span>
<span class="c1"># associated cross sections at different fluence point (separated by dphi)</span>
<div class="viewcode-block" id="bateman_step_solution_matrix"><a class="viewcode-back" href="../../../pythonapi/generated/onix.nax.bateman_step_solution_matrix.html#onix.nax.bateman_step_solution_matrix">[docs]</a><span class="k">def</span> <span class="nf">bateman_step_solution_matrix</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">abun</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">EFPD</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This function calculates the density evolution of a (n,gamma) chain over the length of one fuel batch irradiation. The Bateman solution uses the one-group cross sections obtained from the neutronics simulation of the batch.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chain: dict</span>
<span class="sd">         Dictionnary where keys are z number and entries are (n,gamma) chains</span>
<span class="sd">    abun: List</span>
<span class="sd">         List of natural abundance of each isotope of the (n,gamma) chain</span>
<span class="sd">    batch: onix.nax.Batch</span>
<span class="sd">        Batch object from which one-group cross section evolution are extracted to construct the Bateman solution for the density evlution of the (n,gamma) chain</span>
<span class="sd">    cell: str</span>
<span class="sd">        Name of the BUCell where fluence indicators are to be measured</span>
<span class="sd">    dphi: float</span>
<span class="sd">        The fluence interval that separates each fluence point where Bateman solution is constructed</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">path</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">path</span>
    <span class="n">ng_xs_seq_dict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">ng_xs_seq_dict</span>
    <span class="n">tot_xs_seq_dict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">tot_xs_seq_dict</span>

    <span class="n">fluence_seq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_fluence_seq_until_time</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">EFPD</span><span class="p">)</span>


    <span class="c1">#abun = get_nat_abun_list_from_chain(chain)</span>
    <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="n">mat</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fluence_seq</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">))]</span>
    <span class="n">fluence_points_seq</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fluence_seq</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">bos_fluence</span> <span class="o">=</span> <span class="n">fluence_seq</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
        <span class="n">eos_fluence</span> <span class="o">=</span> <span class="n">fluence_seq</span><span class="p">[</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#step_fluence_length = step_fluence_length_seq[step]</span>
        <span class="n">step_fluence_length</span> <span class="o">=</span> <span class="n">eos_fluence</span> <span class="o">-</span> <span class="n">bos_fluence</span>

        <span class="c1"># List of cumulated fluence interval</span>
        <span class="n">fluence_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">dphi</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">step_fluence_length</span><span class="o">/</span><span class="n">dphi</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span><span class="n">step_fluence_length</span><span class="p">]</span>
        <span class="c1"># List of fluence points for each substep</span>
        <span class="c1">#fluence_points = [dphi*(i+1)+bos_fluence for i in range(int(step_fluence_length/dphi))] + [eos_fluence]</span>
        <span class="n">fluence_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">dphi</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">bos_fluence</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">step_fluence_length</span><span class="o">/</span><span class="n">dphi</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span><span class="n">eos_fluence</span><span class="p">]</span>

        <span class="n">fluence_points_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fluence_points</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)):</span>
            <span class="n">nuclide</span> <span class="o">=</span> <span class="n">get_chain_nuclide_name</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">step_point_wise_density</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_int</span><span class="p">:</span>
                <span class="n">step_point_wise_density</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bateman_step_solution</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">abun</span><span class="p">,</span> <span class="n">nuclide</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">fluence</span><span class="p">,</span> <span class="n">ng_xs_seq_dict</span><span class="p">,</span> <span class="n">tot_xs_seq_dict</span><span class="p">))</span>
            <span class="c1">#step_point_wise_density = [bateman_step_solution(chain, abun, nuclide, step, path, cell, fluence) for fluence in fluence_points]</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_point_wise_density</span>

        <span class="c1"># Update abun (abun list is replaced by last time point abun)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)):</span>
            <span class="n">abun</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">step</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#quit()</span>

    <span class="k">return</span> <span class="n">mat</span><span class="p">,</span> <span class="n">fluence_points_seq</span></div>

<span class="c1"># The fluence in pu_prod_matrix should be the fluence of the NAX material, not of the fissile material</span>
<span class="k">def</span> <span class="nf">pu_prod_matrix</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">,</span> <span class="n">EFPD</span><span class="p">):</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">path_output</span>

    <span class="n">fluence_subseq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_fluence_subseq_until_time</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">,</span> <span class="n">EFPD</span><span class="p">)</span>

    <span class="n">pu_subseq_mat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pu_subseq_mat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">EFPD</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pu_subseq_mat</span><span class="p">,</span> <span class="n">fluence_subseq</span>


<span class="c1"># This function builds a list of bateman_step_solution_matrix according to the operation_history set by the user</span>
<span class="k">def</span> <span class="nf">get_history_matrix_list</span><span class="p">(</span><span class="n">operation_history</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>

    <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="c1"># Look for all different batches in operation history</span>
    <span class="c1"># and make them read cross section of nuclide list in cell</span>
    <span class="n">batch_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">operation_history</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">batch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_list</span><span class="p">:</span>
            <span class="n">batch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">read_nuclide_list_xs</span><span class="p">(</span><span class="n">nuclide_list</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>

    <span class="n">abun</span> <span class="o">=</span> <span class="n">get_nat_abun_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="n">dphi</span> <span class="o">=</span> <span class="mf">1E18</span>

    <span class="n">history_matrix_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">operation_history</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">EFPD</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">step_solution_matrix</span> <span class="o">=</span> <span class="n">bateman_step_solution_matrix</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">abun</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">EFPD</span><span class="p">)</span>
        <span class="n">history_matrix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_solution_matrix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">history_matrix_list</span>

<span class="k">def</span> <span class="nf">get_pu_prod_history_matrix_list</span><span class="p">(</span><span class="n">operation_history</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">):</span>

    <span class="n">pu_prod_history_matrix_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">operation_history</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">EFPD</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pu_prod_history</span> <span class="o">=</span> <span class="n">pu_prod_matrix</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">NAX_cell</span><span class="p">,</span> <span class="n">EFPD</span><span class="p">)</span>
        <span class="n">pu_prod_history_matrix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pu_prod_history</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pu_prod_history_matrix_list</span>

<span class="c1"># This concatenation will NOT add previous batch density to current batch density</span>
<span class="k">def</span> <span class="nf">concatenate_pu_prod_history_matrix</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">):</span>

    <span class="n">pu_prod_history_matrix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">matrix_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">):</span>
        <span class="n">concatenated_dens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">pu_prod_history_matrix_list</span><span class="p">:</span>
            <span class="n">pu_prod_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dens</span> <span class="ow">in</span> <span class="n">pu_prod_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">concatenated_dens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span>

        <span class="n">pu_prod_history_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concatenated_dens</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pu_prod_history_matrix</span>


<span class="c1"># This concatenation will add previous batch density to current batch density</span>
<span class="k">def</span> <span class="nf">concatenate_pu_cum_prod_history_matrix</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">):</span>

    <span class="n">pu_cum_prod_history_matrix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">matrix_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pu_prod_history_matrix_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">):</span>
        <span class="n">concatenated_dens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eos_dens</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">pu_prod_history_matrix_list</span><span class="p">:</span>
            <span class="n">pu_prod_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dens</span> <span class="ow">in</span> <span class="n">pu_prod_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">concatenated_dens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dens</span> <span class="o">+</span> <span class="n">eos_dens</span><span class="p">)</span>
            <span class="n">eos_dens</span> <span class="o">=</span> <span class="n">concatenated_dens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">pu_cum_prod_history_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concatenated_dens</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pu_cum_prod_history_matrix</span>

<span class="c1"># Convert number density to kg. Can be scaled up to the whole system</span>
<span class="k">def</span> <span class="nf">convert_density_to_mass</span><span class="p">(</span><span class="n">concatenated_pu_prod_history_matrix</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">,</span> <span class="n">scale_up_factor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="n">NA</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">NA</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/output_summary&#39;</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_BUCell_vol</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fuel_cell</span><span class="p">)</span>

    <span class="n">mass_pu_prod_history_matrix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">Pu_isotopes_name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Pu_isotopes_name</span>
    <span class="n">Pu_isotopes_zamid</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Pu_isotopes_zamid</span>
    <span class="n">default_atm_mass_lib</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">default_atm_mass_lib</span>
    <span class="n">Pu_isotopes_mass</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">zamid</span> <span class="ow">in</span> <span class="n">Pu_isotopes_zamid</span><span class="p">:</span>
        <span class="n">Pu_isotopes_mass</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_atm_mass_lib</span><span class="p">[</span><span class="n">zamid</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pu_isotopes_name</span><span class="p">)):</span>

        <span class="n">atm_mass</span> <span class="o">=</span> <span class="n">Pu_isotopes_mass</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dens_seq</span> <span class="o">=</span> <span class="n">concatenated_pu_prod_history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scale_up_factor</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mass_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="mf">1E24</span><span class="o">*</span><span class="n">vol</span><span class="o">*</span><span class="n">atm_mass</span><span class="o">*</span><span class="n">scale_up_factor</span><span class="o">*</span><span class="mf">1E-3</span><span class="o">/</span><span class="n">NA</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dens_seq</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mass_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="mf">1E24</span><span class="o">*</span><span class="n">vol</span><span class="o">*</span><span class="n">atm_mass</span><span class="o">/</span><span class="n">NA</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dens_seq</span><span class="p">]</span>
        <span class="n">mass_pu_prod_history_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">mass_pu_prod_history_matrix</span>


<span class="k">def</span> <span class="nf">cumulate_pu_prod_history_matrix</span><span class="p">(</span><span class="n">concatenate_pu_prod_history_matrix</span><span class="p">):</span>

    <span class="n">cumulate_pu_prod_history_matrix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dens_seq</span> <span class="ow">in</span> <span class="n">concatenate_pu_prod_history_matrix</span><span class="p">:</span>
        <span class="n">cum_dens_seq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cum_dens_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dens_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">dens</span> <span class="ow">in</span> <span class="n">dens_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">cum_dens</span> <span class="o">=</span> <span class="n">dens</span> <span class="o">+</span> <span class="n">cum_dens_seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cum_dens_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cum_dens</span><span class="p">)</span>

        <span class="n">cumulate_pu_prod_history_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cum_dens_seq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cumulate_pu_prod_history_matrix</span>

<span class="c1"># This method concatenate each step_solution_matrix in history_matrix_list together so that each nuclide evolution is represented by one array</span>
<span class="k">def</span> <span class="nf">concatenate_history_matrix</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">):</span>

    <span class="n">matrix_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">history_matrix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">nuclide_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">):</span>
        <span class="n">nuclide_concatenated_evolution</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step_solution_matrix</span> <span class="ow">in</span> <span class="n">history_matrix_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nuclide_solution</span> <span class="ow">in</span> <span class="n">step_solution_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nuclide_index</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">nuclide_solution</span><span class="p">:</span>
                    <span class="n">nuclide_concatenated_evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">density</span><span class="p">)</span>

        <span class="n">history_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nuclide_concatenated_evolution</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">history_matrix</span>


<span class="c1"># This method concatenate each flux_points sequence in history_matrix_list together so that fluence evolution is rerepsented by one array</span>
<span class="k">def</span> <span class="nf">concatenate_history_fluence</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">):</span>

    <span class="c1"># The eos_fluence at the end of each step_solution is used to cumulate the fluence</span>
    <span class="n">eos_fluence</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fluence_concatenated_evolution</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">history_matrix_list</span><span class="p">:</span>
        <span class="n">fluence_seq</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fluence_points</span> <span class="ow">in</span> <span class="n">fluence_seq</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_points</span><span class="p">:</span>
                <span class="n">fluence_concatenated_evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fluence</span><span class="o">+</span><span class="n">eos_fluence</span><span class="p">)</span>
        <span class="n">eos_fluence</span> <span class="o">=</span> <span class="n">fluence_concatenated_evolution</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


    <span class="k">return</span> <span class="n">fluence_concatenated_evolution</span>

<span class="k">def</span> <span class="nf">fraction_derivative</span><span class="p">(</span><span class="n">concatenate_history_matrix</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>

    <span class="n">fraction_derivative_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fraction_derivative</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fraction_evolution</span> <span class="o">=</span> <span class="n">concatenate_history_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fraction_evolution</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># if index in step_break_indexes:</span>
            <span class="c1">#   index += 1</span>
            <span class="c1">#   continue</span>
            <span class="c1">#derivative = abs((fraction_evolution[i+1]-fraction_evolution[i])/(history_fluence[i+1]-history_fluence[i]))</span>
            <span class="n">derivative</span> <span class="o">=</span> <span class="p">(</span><span class="n">fraction_evolution</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fraction_evolution</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># print (&#39;ratio diff&#39;,ratio_evolution[i+1]-ratio_evolution[i])</span>
            <span class="c1"># print (&#39;fluence diff&#39;,(history_fluence[i+1]-history_fluence[i]))</span>
            <span class="n">fraction_derivative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivative</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">fraction_derivative_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fraction_derivative</span>

    <span class="k">return</span> <span class="n">fraction_derivative_dict</span>


    <span class="c1"># This method concatenate each flux_points sequence in history_matrix_list together so that fluence evolution is rerepsented by one array</span>
<span class="k">def</span> <span class="nf">concatenate_history_fluence_from_pu_prod_matrix_list</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">):</span>

    <span class="c1"># The eos_fluence at the end of each step_solution is used to cumulate the fluence</span>
    <span class="n">eos_fluence</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fluence_concatenated_evolution</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">history_matrix_list</span><span class="p">:</span>
        <span class="n">fluence_seq</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_seq</span> <span class="p">:</span>
            <span class="n">fluence_concatenated_evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fluence</span><span class="o">+</span><span class="n">eos_fluence</span><span class="p">)</span>
        <span class="n">eos_fluence</span> <span class="o">=</span> <span class="n">fluence_concatenated_evolution</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


    <span class="k">return</span> <span class="n">fluence_concatenated_evolution</span>

<span class="c1"># This method stores the indexes of each new steps</span>
<span class="c1"># It is used in derivative to locate the index where discontinuity appears and bypass them </span>
<span class="k">def</span> <span class="nf">locate_step_break</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">):</span>

    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">step_solution_matrix</span> <span class="ow">in</span> <span class="n">history_matrix_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fluence_points</span> <span class="ow">in</span> <span class="n">step_solution_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_points</span><span class="p">:</span>
                <span class="n">index</span>  <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">index_list</span>

<span class="k">def</span> <span class="nf">locate_batch_break</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">):</span>

    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">batch_solution_matrix</span> <span class="ow">in</span> <span class="n">history_matrix_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#index_list.append(index-1)</span>
            <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fluence_points</span> <span class="ow">in</span> <span class="n">batch_solution_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_points</span><span class="p">:</span>
                <span class="n">index</span>  <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># add the before last index </span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="n">index_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">index_list</span>

<span class="k">def</span> <span class="nf">locate_batch_break_end_start</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">):</span>

    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">batch_solution_matrix</span> <span class="ow">in</span> <span class="n">history_matrix_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fluence_points</span> <span class="ow">in</span> <span class="n">batch_solution_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_points</span><span class="p">:</span>
                <span class="n">index</span>  <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># add the before last index </span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="n">index_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">index_list</span>

<span class="k">def</span> <span class="nf">locate_batch_break_from_pu_prod_matrix_list</span><span class="p">(</span><span class="n">history_matrix_list</span><span class="p">):</span>

    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">batch_solution_matrix</span> <span class="ow">in</span> <span class="n">history_matrix_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#index_list.append(index-1)</span>
            <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">batch_solution_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">index</span>  <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># add the before last index </span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="n">index_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">index_list</span>

<span class="k">def</span> <span class="nf">get_ratio_evolution</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">):</span>

    <span class="n">ratio_evolution_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Lower A as denominator</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">nucl_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nucl_nat_abun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nucl_nat_abun</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># We turn the ratio upside down</span>
            <span class="n">num_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">num_nat_abun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">num_evolution</span> <span class="o">=</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">deno_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">deno_evolution</span> <span class="o">=</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">/</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">num_evolution</span><span class="p">,</span> <span class="n">deno_evolution</span><span class="p">)]</span>
                <span class="n">ratio_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_name</span><span class="p">,</span> <span class="n">deno_name</span><span class="p">)</span>
                <span class="n">ratio_evolution_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio_evolution</span>
                <span class="n">ratio_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">nucl_nat_abun</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">deno_name</span> <span class="o">=</span> <span class="n">nucl_name</span>
            <span class="n">deno_nat_abun</span> <span class="o">=</span> <span class="n">nucl_nat_abun</span>
            <span class="n">deno_evolution</span> <span class="o">=</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">num_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">num_evolution</span> <span class="o">=</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">/</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">num_evolution</span><span class="p">,</span> <span class="n">deno_evolution</span><span class="p">)]</span>
                <span class="n">ratio_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_name</span><span class="p">,</span> <span class="n">deno_name</span><span class="p">)</span>
                <span class="n">ratio_evolution_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio_evolution</span>
                <span class="n">ratio_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio_name</span><span class="p">)</span>

    <span class="c1"># #Higher A as denominator</span>
    <span class="c1"># for i in range(len(chain)-1):</span>
    <span class="c1">#   data = chain[i-1]</span>
    <span class="c1">#   nucl_name = data[0]</span>
    <span class="c1">#   nucl_nat_abun = data[1]</span>
    <span class="c1">#   if nucl_nat_abun == 0:</span>
    <span class="c1">#       # We turn the ratio upside down</span>
    <span class="c1">#       num_name = data[0]</span>
    <span class="c1">#       num_nat_abun = data[1]</span>
    <span class="c1">#       num_evolution = history_matrix[i-1]</span>
    <span class="c1">#       for j in range(i+1, len(chain)):</span>
    <span class="c1">#           data = chain[j-1]</span>
    <span class="c1">#           deno_name = data[0]</span>
    <span class="c1">#           deno_evolution = history_matrix[j-1]</span>
    <span class="c1">#           ratio_evolution = [x/y for x,y in zip(num_evolution, deno_evolution)]</span>
    <span class="c1">#           ratio_name = &#39;{}/{}&#39;.format(num_name, deno_name)</span>
    <span class="c1">#           if ratio_name in ratio_evolution_dict:</span>
    <span class="c1">#               continue</span>
    <span class="c1">#           ratio_evolution_dict[ratio_name] = ratio_evolution</span>
    <span class="c1">#           ratio_name_list.append(ratio_name)</span>

    <span class="c1">#   elif nucl_nat_abun != 0:</span>
    <span class="c1">#       deno_name = nucl_name</span>
    <span class="c1">#       deno_nat_abun = nucl_nat_abun</span>
    <span class="c1">#       deno_evolution = history_matrix[i-1]</span>
    <span class="c1">#       for j in range(i+1, len(chain)):</span>
    <span class="c1">#           data = chain[j-1]</span>
    <span class="c1">#           num_name = data[0]</span>
    <span class="c1">#           num_evolution = history_matrix[j-1]</span>
    <span class="c1">#           ratio_evolution = [x/y for x,y in zip(num_evolution, deno_evolution)]</span>
    <span class="c1">#           ratio_name = &#39;{}/{}&#39;.format(num_name, deno_name)</span>
    <span class="c1">#           if ratio_name in ratio_evolution_dict:</span>
    <span class="c1">#               continue</span>
    <span class="c1">#           ratio_evolution_dict[ratio_name] = ratio_evolution</span>
    <span class="c1">#           ratio_name_list.append(ratio_name)</span>

    <span class="c1"># onix always take the ratio of the higher A over lower A. However, this configuration fails sometime because</span>
    <span class="c1"># the lower A isotope drops to zero and the ratio presents a singulatiry</span>
    <span class="c1"># In this situation, onix invert the ratio</span>
    <span class="c1">#invert_ratio(ratio_evolution_dict, ratio_name_list)</span>

    <span class="k">return</span> <span class="n">ratio_evolution_dict</span><span class="p">,</span> <span class="n">ratio_name_list</span>

<span class="k">def</span> <span class="nf">get_duo_evolution</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">):</span>

    <span class="n">duo_evolution_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">duo_name_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">nucl1_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nucl1_evolution</span> <span class="o">=</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">nucl2_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nucl2_evolution</span> <span class="o">=</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">duo_evolution</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nucl1_evolution</span><span class="p">,</span> <span class="n">nucl2_evolution</span><span class="p">)]</span>
            <span class="n">duo_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nucl2_name</span><span class="p">,</span> <span class="n">nucl1_name</span><span class="p">)</span>
            <span class="n">duo_evolution_dict</span><span class="p">[</span><span class="n">duo_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">duo_evolution</span>
            <span class="n">duo_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duo_name</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">duo_evolution_dict</span><span class="p">,</span> <span class="n">duo_name_list</span>

<span class="k">def</span> <span class="nf">invert_ratio</span><span class="p">(</span><span class="n">ratio_evolution_dict</span><span class="p">,</span> <span class="n">ratio_name_list</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)):</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="n">ratio_evolution_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">invert</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratio_evolution</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">invert</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">invert</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="n">inverted_ratio_evolution</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ratio_evolution</span><span class="p">]</span>
            <span class="n">inverted_ratio_name</span> <span class="o">=</span> <span class="n">invert_ratio_name</span><span class="p">(</span><span class="n">ratio_name</span><span class="p">)</span>
            <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inverted_ratio_name</span>
            <span class="n">ratio_evolution_dict</span><span class="p">[</span><span class="n">inverted_ratio_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">inverted_ratio_evolution</span>
            <span class="k">del</span> <span class="n">ratio_evolution_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">invert_ratio_name</span><span class="p">(</span><span class="n">ratio_name</span><span class="p">):</span>

    <span class="n">separate_name</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">inverted_ratio_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">separate_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">separate_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">inverted_ratio_name</span>


<span class="c1"># Derivative of ratio over fluence</span>
<span class="k">def</span> <span class="nf">get_ratio_derivative_dict</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="p">,</span> <span class="n">step_break_indexes</span><span class="p">):</span>

    <span class="n">ratio_derivative_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ratio_evolution_dict</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ratio_name</span> <span class="ow">in</span> <span class="n">ratio_evolution_dict</span><span class="p">:</span>
        <span class="n">ratio_derivative</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">smoother_batch_derivative_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="n">ratio_evolution_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># if index in step_break_indexes:</span>
            <span class="c1">#   index += 1</span>
            <span class="c1">#   continue</span>
            <span class="c1">#derivative = abs((ratio_evolution[i+1]-ratio_evolution[i])/(history_fluence[i+1]-history_fluence[i]))</span>
            <span class="n">mid_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratio_evolution</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ratio_evolution</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">derivative</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">ratio_evolution</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ratio_evolution</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="c1"># print (&#39;ratio diff&#39;,ratio_evolution[i+1]-ratio_evolution[i])</span>
            <span class="c1"># print (&#39;fluence diff&#39;,(history_fluence[i+1]-history_fluence[i]))</span>
            <span class="n">ratio_derivative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivative</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">ratio_derivative_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio_derivative</span>
        <span class="c1">#ratio_derivative_dict[ratio_name] = smoother_ratio_derivative</span>
    <span class="k">return</span> <span class="n">ratio_derivative_dict</span>

<span class="c1"># Derivative of fluence over ratio</span>
<span class="k">def</span> <span class="nf">get_fluence_derivative_dict</span><span class="p">(</span><span class="n">ratio_derivative_dict</span><span class="p">):</span>

    <span class="n">fluence_derivative_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ratio_name</span> <span class="ow">in</span> <span class="n">ratio_derivative_dict</span><span class="p">:</span>
        <span class="n">ratio_derivative</span> <span class="o">=</span> <span class="n">ratio_derivative_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">fluence_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ratio_derivative</span><span class="p">]</span>
        <span class="n">fluence_derivative_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluence_derivative</span>

    <span class="k">return</span> <span class="n">fluence_derivative_dict</span>



<span class="c1"># since the derivative of the ratio is found at midpoints between two ratio points,</span>
<span class="c1"># we need to compute the equivalient mid point fluence</span>
<span class="c1"># mid fluence also bypass step break points</span>
<span class="k">def</span> <span class="nf">get_history_mid_fluence</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">step_break_indexes</span><span class="p">):</span>

    <span class="n">history_mid_fluence</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># if i in step_break_indexes:</span>
        <span class="c1">#   continue</span>
        <span class="n">history_mid_fluence</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">history_mid_fluence</span>

<span class="c1"># Probably useless</span>
<span class="c1"># Only ratio where the denon is initially non-zero is usable</span>
<span class="c1"># def get_usable_ratio(chain):</span>

<span class="c1">#   ratio_name_list = []</span>
<span class="c1">#   for i in range(len(chain)-1):</span>
<span class="c1">#       data = chain[i]</span>
<span class="c1">#       deno_name = data[0]</span>
<span class="c1">#       deno_nat_abun = data[1]</span>
<span class="c1">#       if deno_nat_abun == 0:</span>
<span class="c1">#           continue</span>
<span class="c1">#       else:</span>
<span class="c1">#           for j in range(i+1, len(chain)):</span>
<span class="c1">#               data = chain[j]</span>
<span class="c1">#               num_name = data[0]</span>
<span class="c1">#               ratio_name_list.append(&#39;{}/{}&#39;.format(num_name, deno_name))</span>

<span class="c1">#   return ratio_name_list</span>

<span class="k">def</span> <span class="nf">sample_ratio_evolution_on_fluence_grid</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">old_fluence_grid</span><span class="p">,</span> <span class="n">new_fluence_grid</span><span class="p">):</span>

    <span class="n">tabulated_ratio</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Tabulated1D</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">old_fluence_grid</span><span class="p">)</span>

    <span class="n">sampled_ratio</span> <span class="o">=</span> <span class="n">tabulated_ratio</span><span class="p">(</span><span class="n">new_fluence_grid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sampled_ratio</span>

<span class="k">def</span> <span class="nf">get_combine_indexes</span><span class="p">(</span><span class="n">index_list1</span><span class="p">,</span> <span class="n">index_list2</span><span class="p">):</span>

    <span class="n">combined_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">index_list1</span><span class="o">+</span><span class="n">index_list2</span><span class="p">))</span>
    <span class="n">combined_indexes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">combined_indexes</span>
    
<span class="k">def</span> <span class="nf">sampled_index</span><span class="p">(</span><span class="n">batch_break_indexes</span><span class="p">):</span>

    <span class="n">point_per_batch</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="n">previous_break_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sampled_index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_break_indexes</span><span class="p">)):</span>
        <span class="n">break_index</span> <span class="o">=</span> <span class="n">batch_break_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">int_length</span> <span class="o">=</span> <span class="n">break_index</span> <span class="o">-</span> <span class="n">previous_break_index</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">int_length</span><span class="o">/</span><span class="n">point_per_batch</span><span class="p">)</span>
        <span class="n">batch_sampled_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">step</span> <span class="o">+</span> <span class="n">previous_break_index</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">point_per_batch</span><span class="p">)]</span> <span class="o">+</span><span class="p">[</span><span class="n">break_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">previous_break_index</span> <span class="o">=</span> <span class="n">break_index</span>
        <span class="n">sampled_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_sampled_index</span><span class="p">)</span>

    <span class="n">sampled_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">sampled_index_list</span><span class="p">))</span>


    <span class="k">return</span> <span class="n">sampled_index</span>

<span class="k">def</span> <span class="nf">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_indexes</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>


    <span class="n">sampled_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sampled_indexes</span><span class="p">:</span>
        <span class="n">sampled_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">sampled_data</span>
    

<span class="k">def</span> <span class="nf">plot_ng_chain_ratio_derivative_history</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">ratio_derivative_dict</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">,</span> <span class="n">sampled_index</span><span class="p">):</span>

    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">sampled_history_fluence</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ratio_derivative</span> <span class="o">=</span> <span class="n">ratio_derivative_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">sampled_ratio_derivative</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">ratio_derivative</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">,</span> <span class="n">sampled_ratio_derivative</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio derivative&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_chain_fluence_relative_error_history</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">fluence_derivative_dict</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">,</span> <span class="n">sampled_index</span><span class="p">):</span>

    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">sampled_history_fluence</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fluence_derivative</span> <span class="o">=</span> <span class="n">fluence_derivative_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">sampled_fluence_derivative</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">fluence_derivative</span><span class="p">)</span>
        <span class="n">relative_error_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">/</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sampled_fluence_derivative</span><span class="p">,</span> <span class="n">sampled_history_fluence</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">,</span> <span class="n">relative_error_seq</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fluence relative error&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_selected_fluence_relative_error_history</span><span class="p">(</span><span class="n">selected_list</span><span class="p">,</span> <span class="n">selected_ratio_dict</span><span class="p">,</span> <span class="n">selected_fluence_derivative_dict</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">,</span> <span class="n">sampled_index</span><span class="p">,</span> <span class="n">ratio_uncertainty</span><span class="p">,</span> <span class="n">cut_off</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="c1">#plt.style.use(&#39;dark_background&#39;)</span>

    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">selected_list</span>
    <span class="n">sampled_history_fluence</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">)</span>

    <span class="n">marker_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">linestyle_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">]</span>

    <span class="c1"># normalize history_mid_fluence (to remove scientific notation)</span>
    <span class="n">history_mid_fluence_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mf">1E21</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">history_mid_fluence</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fluence_derivative</span> <span class="o">=</span> <span class="n">selected_fluence_derivative_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>

        <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="n">selected_ratio_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">mid_ratio_evolution</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>

        <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cut_off</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ratio_name</span> <span class="ow">in</span> <span class="n">cut_off</span><span class="p">:</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="n">cut_off</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>

        <span class="n">sample</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>

        <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
        <span class="c1">########### NON SAMPLED</span>

            <span class="n">relative_error_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">ratio_uncertainty</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fluence_derivative</span><span class="p">,</span> <span class="n">mid_ratio_evolution</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">)]</span>
            <span class="c1">#relative_error_seq = [x*ratio_uncertainty/y for x, y in zip(fluence_derivative, history_mid_fluence)]</span>
            <span class="n">smooth_relative_error_seq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">moving_average</span><span class="p">(</span><span class="n">relative_error_seq</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">x_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history_mid_fluence</span><span class="p">))]</span>


            <span class="c1"># Non sampled</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_mid_fluence_norm</span><span class="p">[:</span><span class="n">cut</span><span class="p">],</span> <span class="n">relative_error_seq</span><span class="p">[:</span><span class="n">cut</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_mid_fluence_norm</span><span class="p">,</span> <span class="n">relative_error_seq</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
                <span class="c1">#plt.plot(x_seq, relative_error_seq, linestyle = linestyle, label = ratio_name)</span>

            <span class="c1"># Threeshold line</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1E-2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history_mid_fluence_norm</span><span class="p">))]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_mid_fluence_norm</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="c1">########## SAMPLED</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">AH</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">sampled_mid_ratio_evolution</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">mid_ratio_evolution</span><span class="p">)</span>
            <span class="n">sampled_fluence_derivative</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">fluence_derivative</span><span class="p">)</span>
            <span class="n">relative_error_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">ratio_uncertainty</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sampled_fluence_derivative</span><span class="p">,</span><span class="n">sampled_mid_ratio_evolution</span><span class="p">,</span> <span class="n">sampled_history_fluence</span><span class="p">)]</span>
            <span class="n">smooth_relative_error_seq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">moving_average</span><span class="p">(</span><span class="n">relative_error_seq</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1">#ax1.plot(sampled_history_fluence, relative_error_seq, linestyle = linestyle, label = ratio_name)   </span>

            <span class="n">x_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">[:</span><span class="n">cut</span><span class="p">],</span> <span class="n">relative_error_seq</span><span class="p">[:</span><span class="n">cut</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#plt.plot(x_seq, relative_error_seq, linestyle = linestyle, label = ratio_name)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">,</span> <span class="n">relative_error_seq</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>

            <span class="c1"># Threeshold line</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1E-2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">))]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>

        
        <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>




    <span class="c1"># ##Fluence at each batch break point</span>

    <span class="c1"># batch_break_fluence = [history_mid_fluence_norm[i] for i in batch_break_indexes]</span>
    <span class="c1"># #plt.axvline(x=0, linestyle = &#39;--&#39;, color =&#39;grey&#39;)</span>
    <span class="c1"># for fluence in batch_break_fluence:</span>
    <span class="c1">#     plt.axvline(x=fluence, linestyle = &#39;--&#39;, color =&#39;grey&#39;)</span>


    <span class="c1">####Custom vertical lines with labels</span>

    <span class="c1"># 3 years operation for monitor tag with each year labelled</span>
    <span class="n">tag_yearly_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">history_mid_fluence_norm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">tag_yearly_label</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fluence</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>




    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fluence relative error&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">1E-4</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence [10$^</span><span class="si">{21}</span><span class="s1">$ $</span><span class="se">\\</span><span class="s1">times$ cm/cm$^</span><span class="si">{3}</span><span class="s1">$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>


    <span class="c1"># Put these freaking Shutdown dates on the top</span>

    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>


    <span class="c1"># ## Batch breaks</span>

    <span class="c1"># ax3.set_xticks(batch_break_fluence)</span>
    <span class="c1"># ax3.set_xticklabels([&#39;Shutdown\nApril 1994&#39;, &#39;Shutdown\nApril 2005&#39;, &#39;Shutdown\nJuly 2007&#39;, &#39;Shutdown\nOctober 2015&#39;, &#39;Shutdown\nMarch 2018&#39;])</span>


    <span class="c1">### Custom labels</span>

    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tag_yearly_label</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;1 year&#39;</span><span class="p">,</span> <span class="s1">&#39;2 years&#39;</span><span class="p">,</span> <span class="s1">&#39;3 years&#39;</span><span class="p">])</span>


    <span class="c1">#plt.xscale(&#39;log&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_fluence_relative_error_with_ratio_history</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">fluence_derivative_dict</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">,</span> <span class="n">sampled_index</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">ratio_uncertainty</span><span class="p">):</span>

    <span class="c1">#ratio_evoluton_dict = ratio_evolution[0]</span>
    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ratio_evolution_dict</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
    <span class="n">sampled_history_fluence</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ratio_evolution</span> <span class="o">=</span> <span class="n">ratio_evolution_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">mid_ratio_evolution</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ratio_evolution</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="n">fluence_derivative</span> <span class="o">=</span> <span class="n">fluence_derivative_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>

        <span class="n">sampled_mid_ratio_evolution</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">mid_ratio_evolution</span><span class="p">)</span>
        <span class="n">sampled_fluence_derivative</span> <span class="o">=</span> <span class="n">sample_data_with_sample_indexes</span><span class="p">(</span><span class="n">sampled_index</span><span class="p">,</span> <span class="n">fluence_derivative</span><span class="p">)</span>
        <span class="n">relative_error_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">ratio_uncertainty</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sampled_fluence_derivative</span><span class="p">,</span><span class="n">sampled_mid_ratio_evolution</span><span class="p">,</span> <span class="n">sampled_history_fluence</span><span class="p">)]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">,</span> <span class="n">relative_error_seq</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>    

        <span class="c1">#relative_error_seq = [x*ratio_uncertainty*k/y for x,k, y in zip(fluence_derivative, mid_ratio_evolution, history_fluence)]</span>
        <span class="c1">#ax1.plot(history_fluence[:-1], relative_error_seq, linestyle = linestyle, label = ratio_name)</span>
        
        <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="c1"># Threeshold line</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1E-2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">))]</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_history_fluence</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>

    <span class="c1">#line = [1E-2 for x in range(len(history_fluence))]</span>
    <span class="c1">#ax1.plot(sampled_history_fluence, line, &#39;r&#39;, linestyle = &#39;--&#39;)</span>
    <span class="c1">#ax1.plot(history_fluence, line, &#39;r&#39;, linestyle = &#39;--&#39;)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Fluence relative error&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="c1">#ax1.set_xscale(&#39;log&#39;)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nuclide_list</span><span class="p">)):</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">nuclide_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Atomic fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>






<span class="k">def</span> <span class="nf">plot_chain_fraction_derivative_history</span><span class="p">(</span><span class="n">fraction_derivative_dict</span><span class="p">,</span> <span class="n">history_mid_fluence</span><span class="p">):</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fraction_derivative_dict</span><span class="p">:</span>
        <span class="n">fraction_derivative</span> <span class="o">=</span> <span class="n">fraction_derivative_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_mid_fluence</span><span class="p">,</span> <span class="n">fraction_derivative</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction derivative&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



<span class="k">def</span> <span class="nf">plot_ng_chain_ratio_history</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ratio_evolution</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">):</span>

    <span class="n">ratio_evoluton_dict</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">ratio_evolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio_evoluton_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio_evoluton_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_selected_ratio_history</span><span class="p">(</span><span class="n">selected_list</span><span class="p">,</span> <span class="n">selected_ratio_dict</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">selected_list</span>
    <span class="c1">#plt.style.use(&#39;dark_background&#39;)</span>

    <span class="c1"># normalize history_mid_fluence (to remove scientific notation)</span>
    <span class="n">history_fluence</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mf">1E21</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">history_fluence</span><span class="p">]</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;fluence&#39;</span><span class="p">,</span><span class="n">history_fluence</span><span class="p">)</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)):</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">selected_ratio_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">invert</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ratio_name</span> <span class="ow">in</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ratio</span><span class="p">]</span>
                <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ratio_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>




    <span class="c1"># ##Fluence at each batch break point</span>

    <span class="c1"># batch_break_fluence = [history_fluence[i] for i in batch_break_indexes]</span>

    <span class="c1"># #plt.axvline(x=0, linestyle = &#39;--&#39;, color =&#39;grey&#39;)</span>
    <span class="c1"># for fluence in batch_break_fluence:</span>
    <span class="c1">#     print (fluence)</span>
    <span class="c1">#     plt.axvline(x=fluence, linestyle = &#39;--&#39;, color =&#39;grey&#39;)</span>


    <span class="c1">###Custom vertical lines with labels</span>

    <span class="c1"># 3 years operation for monitor tag with each year labelled</span>
    <span class="n">tag_yearly_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">history_fluence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">tag_yearly_label</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fluence</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>





    <span class="c1"># plt.axvspan(batch_break_fluence[0], batch_break_fluence[2], alpha=0.2, color=&#39;grey&#39;)</span>
    <span class="c1"># plt.axvspan(batch_break_fluence[9], batch_break_fluence[12], alpha=0.2, color=&#39;grey&#39;)</span>


    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence [10$^</span><span class="si">{21}</span><span class="s1">$ $</span><span class="se">\\</span><span class="s1">times$ cm/cm$^</span><span class="si">{3}</span><span class="s1">$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="c1">#ax.yaxis.set_major_formatter(MathTextSciFormatter(&quot;%1.2e&quot;))</span>

    <span class="c1">#ax.set_ylim(bottom = 0, top=3.1)</span>

    <span class="c1">#ax.set_ylim(bottom = 0, top=3000)</span>
    <span class="c1">#plt.legend(prop={&#39;size&#39;: 12})</span>


    <span class="c1">#Put these freaking Shutdown dates on the top</span>

    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>


    <span class="c1"># # ## Batch breaks</span>

    <span class="c1"># ax3.set_xticks(batch_break_fluence)</span>
    <span class="c1"># ax3.set_xticklabels([&#39;Shutdown\nApril 1994&#39;, &#39;Shutdown\nApril 2005&#39;, &#39;Shutdown\nJuly 2007&#39;, &#39;Shutdown\nOctober 2015&#39;, &#39;Shutdown\nMarch 2018&#39;])</span>

    <span class="c1"># ### Custom labels</span>

    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tag_yearly_label</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;1 year&#39;</span><span class="p">,</span> <span class="s1">&#39;2 years&#39;</span><span class="p">,</span> <span class="s1">&#39;3 years&#39;</span><span class="p">])</span>


    <span class="c1">#ax3.set_ylim(bottom = 0, top=3.1)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_selected_duo_history</span><span class="p">(</span><span class="n">selected_list</span><span class="p">,</span> <span class="n">selected_duo_dict</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">duo_name_list</span> <span class="o">=</span> <span class="n">selected_list</span>
    <span class="c1">#plt.style.use(&#39;dark_background&#39;)</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">duo_name_list</span><span class="p">)):</span>
        <span class="n">duo_name</span> <span class="o">=</span> <span class="n">duo_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">duo</span> <span class="o">=</span> <span class="n">selected_duo_dict</span><span class="p">[</span><span class="n">duo_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">duo</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">duo_name</span><span class="p">)</span>

    <span class="c1">####Fluence at each batch break point</span>
    <span class="c1"># batch_break_fluence = [history_fluence[i] for i in batch_break_indexes]</span>

    <span class="c1"># #plt.axvline(x=0, linestyle = &#39;--&#39;, color =&#39;grey&#39;)</span>
    <span class="c1"># for fluence in batch_break_fluence:</span>
    <span class="c1">#     print (fluence)</span>
    <span class="c1">#     plt.axvline(x=fluence, linestyle = &#39;--&#39;, color =&#39;grey&#39;)</span>

    <span class="c1">####Custom vertical lines with labels</span>

    <span class="c1"># 3 years operation for monitor tag with each year labelled</span>
    <span class="n">tag_yearly_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">history_fluence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">tag_yearly_label</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fluence</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>


    <span class="c1"># plt.axvspan(batch_break_fluence[0], batch_break_fluence[2], alpha=0.2, color=&#39;grey&#39;)</span>
    <span class="c1"># plt.axvspan(batch_break_fluence[9], batch_break_fluence[12], alpha=0.2, color=&#39;grey&#39;)</span>


    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Duo fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence [cm/cm$^</span><span class="si">{3}</span><span class="s1">$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#ax.set_ylim(bottom = 0, top=3.1)</span>
    <span class="c1">#ax.set_ylim(bottom = 0, top=60)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>

    <span class="c1"># Put these freaking Shutdown dates on the top</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="c1">### Batch breaks</span>
    <span class="c1">#ax3.set_xticks(batch_break_fluence)</span>
    <span class="c1">#ax3.set_xticklabels([&#39;Shutdown\nApril 1994&#39;, &#39;Shutdown\nApril 2005&#39;, &#39;Shutdown\nJuly 2007&#39;, &#39;Shutdown\nOctober 2015&#39;, &#39;Shutdown\nMarch 2018&#39;])</span>

    <span class="c1">### Custom labels</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tag_yearly_label</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;1 year&#39;</span><span class="p">,</span> <span class="s1">&#39;2 years&#39;</span><span class="p">,</span> <span class="s1">&#39;3 years&#39;</span><span class="p">])</span>


    <span class="c1">#ax3.set_ylim(bottom = 0, top=3.1)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_selected_ratio_history_sup1</span><span class="p">(</span><span class="n">selected_list</span><span class="p">,</span> <span class="n">selected_ratio_dict</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">ratio_name_list</span> <span class="o">=</span> <span class="n">selected_list</span>
    <span class="c1">#plt.style.use(&#39;dark_background&#39;)</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio_name_list</span><span class="p">)):</span>
        <span class="n">ratio_name</span> <span class="o">=</span> <span class="n">ratio_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">selected_ratio_dict</span><span class="p">[</span><span class="n">ratio_name</span><span class="p">]</span>
        <span class="n">ratio_sup1</span> <span class="o">=</span> <span class="n">convert_ratio_to_sup1</span><span class="p">(</span><span class="n">ratio</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">switch_indexes</span> <span class="o">=</span> <span class="n">convert_ratio_to_sup1</span><span class="p">(</span><span class="n">ratio</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">switch_x</span>  <span class="o">=</span> <span class="p">[</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">switch_indexes</span><span class="p">]</span>
        <span class="n">switch_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">ratio_sup1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">switch_indexes</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">ratio_sup1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ratio_name</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">ratio_name</span><span class="p">,</span> <span class="s1">&#39;switch&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">switch_indexes</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">switch_x</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">switch_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">switch_x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">switch_x</span><span class="p">,</span> <span class="n">switch_y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1">#Fluence at each batch break point</span>
    <span class="n">batch_break_fluence</span> <span class="o">=</span> <span class="p">[</span><span class="n">history_fluence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch_break_indexes</span><span class="p">]</span>
    <span class="c1">#plt.axvline(x=0, linestyle = &#39;--&#39;, color =&#39;grey&#39;)</span>
    <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">batch_break_fluence</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">fluence</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fluence</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>

    <span class="c1">#quit()</span>

    <span class="c1"># plt.axvspan(batch_break_fluence[0], batch_break_fluence[2], alpha=0.2, color=&#39;grey&#39;)</span>
    <span class="c1"># plt.axvspan(batch_break_fluence[9], batch_break_fluence[12], alpha=0.2, color=&#39;grey&#39;)</span>


    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence [cm/cm$^</span><span class="si">{3}</span><span class="s1">$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>

    <span class="c1"># Put these freaking Shutdown dates on the top</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">batch_break_fluence</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Shutdown</span><span class="se">\n</span><span class="s1">April 1994&#39;</span><span class="p">,</span> <span class="s1">&#39;Shutdown</span><span class="se">\n</span><span class="s1">April 2005&#39;</span><span class="p">,</span> <span class="s1">&#39;Shutdown</span><span class="se">\n</span><span class="s1">July 2007&#39;</span><span class="p">,</span> <span class="s1">&#39;Shutdown</span><span class="se">\n</span><span class="s1">October 2015&#39;</span><span class="p">,</span> <span class="s1">&#39;Shutdown</span><span class="se">\n</span><span class="s1">March 2018&#39;</span><span class="p">])</span>

    <span class="c1">#ax3.set_ylim(bottom = 0, top=3.1)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">convert_ratio_to_sup1</span><span class="p">(</span><span class="n">ratio</span><span class="p">):</span>

    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">converted_ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio</span><span class="p">)):</span>
        <span class="n">ratio_value</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ratio_value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">converted_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ratio_value</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ratio_value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ratio</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ratio_value</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ratio</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">converted_ratio</span><span class="p">,</span> <span class="n">indexes</span>

<span class="k">def</span> <span class="nf">plot_ng_chain_densities_history</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">,</span> <span class="n">history_fluence</span><span class="p">,</span> <span class="n">different_axes</span><span class="p">):</span>

    <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="c1">#### This is the data from onix ####</span>
    <span class="c1">#### Just to compare evolution of Bateman for whole history to Salameche density evolution</span>
    <span class="c1">#### for one simulation</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="s1">&#39;Clad&#39;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/home/julien/Open-Burnup.dev/test_cluster/della/IVB/case5/cycle1/activation/test12_Ti-B-La_solution3/output_summary&#39;</span>

    <span class="n">fluence_seq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_fluence_seq</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
    <span class="n">salameche_densities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">_dens&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nuclide</span> <span class="ow">in</span> <span class="n">nuclide_list</span><span class="p">:</span>
        <span class="n">nuclide_density</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_dens</span><span class="p">(</span><span class="n">nuclide</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">normalized_density</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="mf">1E8</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nuclide_density</span><span class="p">]</span>
        <span class="n">salameche_densities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_density</span><span class="p">)</span>

    <span class="c1">#########</span>

    <span class="k">if</span> <span class="n">different_axes</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>

        <span class="n">f</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nuclide_list</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">nuclide_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fluence_seq</span><span class="p">,</span> <span class="n">salameche_densities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density [atm/cm3]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">different_axes</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nuclide_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_fluence</span><span class="p">,</span> <span class="n">history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">nuclide_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Atomic fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_eos_abun_from_matrix</span><span class="p">(</span><span class="n">step_solution_matrix</span><span class="p">):</span>

    <span class="n">mat</span> <span class="o">=</span> <span class="n">step_solution_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">)):</span>
        <span class="n">abun</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">abun</span>

<span class="k">def</span> <span class="nf">plot_ng_chain_densities</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">fluence_points_seq</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>

    <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="n">chain_densities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># concatenate densities for each nuclide</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
        <span class="n">joint_densities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">densities_array</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">densities_array</span><span class="p">:</span>
                <span class="n">joint_densities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">density</span><span class="p">)</span>
        <span class="n">chain_densities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint_densities</span><span class="p">)</span>

    <span class="c1"># concatenate fluence points</span>
    <span class="n">joint_fluence</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fluence_points</span> <span class="ow">in</span> <span class="n">fluence_points_seq</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_points</span><span class="p">:</span>
            <span class="n">joint_fluence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fluence</span><span class="p">)</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nuclide_list</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_fluence</span><span class="p">,</span> <span class="n">chain_densities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">nuclide_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density [atm/cm3]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_compare_ng_chain_densities_with_salameche</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">fluence_points_seq</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>

    <span class="n">nuclide_list</span> <span class="o">=</span> <span class="n">get_nuclide_list_from_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="n">chain_densities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">fluence_seq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_fluence_seq</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
    <span class="n">salameche_densities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">_dens&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nuclide</span> <span class="ow">in</span> <span class="n">nuclide_list</span><span class="p">:</span>
        <span class="n">nuclide_density</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_dens</span><span class="p">(</span><span class="n">nuclide</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">normalized_density</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="mf">1E8</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nuclide_density</span><span class="p">]</span>
        <span class="n">salameche_densities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_density</span><span class="p">)</span>

    <span class="c1"># concatenate densities for each nuclide</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
        <span class="n">joint_densities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">densities_array</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">densities_array</span><span class="p">:</span>
                <span class="n">joint_densities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">density</span><span class="p">)</span>
        <span class="n">chain_densities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint_densities</span><span class="p">)</span>

    <span class="c1"># concatenate fluence points</span>
    <span class="n">joint_fluence</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fluence_points</span> <span class="ow">in</span> <span class="n">fluence_points_seq</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">fluence_points</span><span class="p">:</span>
            <span class="n">joint_fluence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fluence</span><span class="p">)</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nuclide_list</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_fluence</span><span class="p">,</span> <span class="n">chain_densities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">nuclide_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fluence_seq</span><span class="p">,</span> <span class="n">salameche_densities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density [atm/cm3]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_cum_pu_prod_against_fluence</span><span class="p">(</span><span class="n">cumulate_pu_prod_history_matrix</span><span class="p">,</span> <span class="n">concatenate_history_fluence</span><span class="p">):</span>

    <span class="n">Pu_isotopes</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Pu_isotopes</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pu_isotopes</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">concatenate_history_fluence</span><span class="p">,</span> <span class="n">cumulate_pu_prod_history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">Pu_isotopes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Density [atm/cm3]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_pu_prod_against_fluence</span><span class="p">(</span><span class="n">concatenate_pu_prod_history_matrix</span><span class="p">,</span> <span class="n">concatenate_history_fluence</span><span class="p">):</span>

    <span class="n">Pu_isotopes</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Pu_isotopes_name</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pu_isotopes</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">concatenate_history_fluence</span><span class="p">,</span> <span class="n">concatenate_pu_prod_history_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">Pu_isotopes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Density [atm/cm3]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_mass_pu_prod_against_fluence</span><span class="p">(</span><span class="n">mass_pu_prod_history_matrix</span><span class="p">,</span> <span class="n">concatenate_history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="n">Pu_isotopes</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Pu_isotopes_name</span>

    <span class="c1"># Tot mass of Pu</span>
    <span class="n">tot_pu_seq</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_pu_prod_history_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">tot_pu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_pu_prod_history_matrix</span><span class="p">)):</span>
            <span class="n">tot_pu</span> <span class="o">+=</span> <span class="n">mass_pu_prod_history_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tot_pu_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_pu</span><span class="p">)</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="c1"># Fluence at each batch break point</span>
    <span class="n">batch_break_fluence</span> <span class="o">=</span> <span class="p">[</span><span class="n">concatenate_history_fluence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch_break_indexes</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">batch_break_fluence</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fluence</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="c1"># tot Pu mass at each batch break point</span>
    <span class="n">batch_break_pu</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">tot_pu_seq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch_break_indexes</span><span class="p">]</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">batch_break_pu</span><span class="p">)</span>

    <span class="c1">#ax2 = ax1.twinx()</span>

    <span class="c1"># for i in range(len(batch_break_indexes)):</span>
    <span class="c1">#   index = batch_break_indexes[i]</span>
    <span class="c1">#   # if i &lt; 2:</span>
    <span class="c1">#   #   batch_fluence_seq = concatenate_history_fluence[:index +1]</span>
    <span class="c1">#   #   batch_tot_pu_line = [round(tot_pu_seq[index ], 1) for x in range(len(batch_fluence_seq))]</span>
    <span class="c1">#   #   ax1.plot(batch_fluence_seq,batch_tot_pu_line, linestyle = &#39;--&#39;, color =&#39;darkgrey&#39;)</span>
    <span class="c1">#   # else:</span>
    <span class="c1">#   #   batch_fluence_seq = concatenate_history_fluence[index:] + [2.37E22]</span>
    <span class="c1">#   #   batch_tot_pu_line = [round(tot_pu_seq[index ], 1) for x in range(len(batch_fluence_seq))]</span>
    <span class="c1">#   #   ax2.plot(batch_fluence_seq,batch_tot_pu_line, linestyle = &#39;--&#39;, color =&#39;darkgrey&#39;)</span>
    <span class="c1">#   batch_fluence_seq = concatenate_history_fluence[:index +1]</span>
    <span class="c1">#   batch_tot_pu_line = [round(tot_pu_seq[index ], 1) for x in range(len(batch_fluence_seq))]</span>
    <span class="c1">#   ax1.plot(batch_fluence_seq,batch_tot_pu_line, linestyle = &#39;--&#39;, color =&#39;darkgrey&#39;)</span>

    <span class="n">previous_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_break_indexes</span><span class="p">)):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">batch_break_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">batch_fluence_seq</span> <span class="o">=</span> <span class="n">concatenate_history_fluence</span><span class="p">[</span><span class="n">previous_index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">batch_tot_pu</span> <span class="o">=</span> <span class="n">tot_pu_seq</span><span class="p">[</span><span class="n">previous_index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># if i&lt;2:</span>
        <span class="c1">#   ax1.plot(batch_fluence_seq, batch_tot_pu, linestyle = &#39;-&#39;, color =&#39;orange&#39;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#   ax2.plot(batch_fluence_seq, batch_tot_pu, linestyle = &#39;-&#39;, color =&#39;orange&#39;)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">batch_fluence_seq</span><span class="p">,</span> <span class="n">batch_tot_pu</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
        <span class="n">previous_index</span> <span class="o">=</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">max_fluence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">concatenate_history_fluence</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mass [kg]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="c1">#ax2.set_ylabel(&#39;Mass [kg]&#39;, fontsize=16)</span>
    <span class="c1">#ax1.set_yticks([0, batch_break_pu[0], batch_break_pu[1]])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence [neutrons cm$^{-2}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">max_fluence</span><span class="p">)</span>
    <span class="c1"># ax1.set_ylim(bottom = 0,top = 31)</span>
    <span class="c1"># ax2.set_ylim(bottom = 0, top = 31)</span>
    <span class="c1">#ax2.yaxis.tick_right()</span>
    <span class="c1">#ax2.set_yticks([0, batch_break_pu[2], batch_break_pu[3]])</span>
    <span class="c1">#ax.yaxis.get_offset_text().set_fontsize(15)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#plt.ticklabel_format(style=&#39;sci&#39;, axis=&#39;y&#39;,scilimits=(0,0))</span>
    <span class="c1"># ax1.grid()</span>
    <span class="c1"># ax2.grid()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#ax2.tick_params(labelsize=15)</span>
    <span class="c1">#plt.legend(prop={&#39;size&#39;: 12})</span>

    <span class="c1"># Put these freaking Shutdown dates on the top</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span> <span class="n">max_fluence</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">batch_break_fluence</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="c1">#ax3.set_xticklabels([&#39;Shutdown\nApril 1994&#39;, &#39;Shutdown\nApril 2005&#39;, &#39;Shutdown\nJuly 2007&#39;, &#39;Shutdown\nOctober 2015&#39;])</span>
    <span class="c1">#ax3.set_xticklabels([&#39;Shutdown\nApril 1994&#39;, &#39;Shutdown\nApril 2005&#39;, &#39;Shutdown\nJuly 2007&#39;, &#39;Shutdown\nOctober 2015&#39;])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_mass_pu_cum_prod_against_fluence</span><span class="p">(</span><span class="n">mass_pu_prod_history_matrix</span><span class="p">,</span> <span class="n">concatenate_history_fluence</span><span class="p">,</span> <span class="n">batch_break_indexes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="n">Pu_isotopes</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Pu_isotopes_name</span>

    <span class="c1"># Tot mass of Pu</span>
    <span class="n">tot_pu_seq</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_pu_prod_history_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">tot_pu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_pu_prod_history_matrix</span><span class="p">)):</span>
            <span class="n">tot_pu</span> <span class="o">+=</span> <span class="n">mass_pu_prod_history_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tot_pu_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_pu</span><span class="p">)</span>

    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;tot_pu_seq&#39;</span><span class="p">,</span><span class="n">tot_pu_seq</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;fluence_seq&#39;</span><span class="p">,</span><span class="n">concatenate_history_fluence</span><span class="p">)</span>
    <span class="n">quit</span><span class="p">()</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="c1"># for i in range(len(Pu_isotopes)):</span>
    <span class="c1">#   ax.plot(concatenate_history_fluence, mass_pu_prod_history_matrix[i], label = Pu_isotopes[i])</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">concatenate_history_fluence</span><span class="p">,</span> <span class="n">tot_pu_seq</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">)</span>

    <span class="c1"># Fluence at each batch break point</span>
    <span class="n">batch_break_fluence</span> <span class="o">=</span> <span class="p">[</span><span class="n">concatenate_history_fluence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch_break_indexes</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">fluence</span> <span class="ow">in</span> <span class="n">batch_break_fluence</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fluence</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="c1"># tot Pu mass at each batch break point</span>
    <span class="n">batch_break_cum_pu</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">tot_pu_seq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch_break_indexes</span><span class="p">]</span>


    <span class="c1"># for i in batch_break_indexes:</span>
    <span class="c1">#   batch_fluence_seq = concatenate_history_fluence[:i]</span>
    <span class="c1">#   batch_tot_pu_line = [round(tot_pu_seq[i],1) for x in range(len(batch_fluence_seq))]</span>
    <span class="c1">#   ax1.plot(batch_fluence_seq,batch_tot_pu_line, linestyle = &#39;--&#39;, color =&#39;darkgrey&#39;)</span>

    <span class="n">max_fluence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">concatenate_history_fluence</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mass [kg]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fluence [neutrons cm$^{-2}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span> <span class="n">max_fluence</span><span class="p">)</span>
    <span class="c1">#ax1.set_ylim(bottom = 0,top = 31)</span>
    <span class="c1">#ax.yaxis.get_offset_text().set_fontsize(15)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_break_cum_pu</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_offset_text</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#plt.ticklabel_format(style=&#39;sci&#39;, axis=&#39;y&#39;,scilimits=(0,0))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># Put these freaking Shutdown dates on the top</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span> <span class="n">max_fluence</span><span class="p">)</span>
    <span class="c1">#ax3.set_xlim(ax1.get_xlim())</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">batch_break_fluence</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="c1">#ax3.set_xticklabels([&#39;Shutdown\nApril 1994&#39;, &#39;Shutdown\nApril 2005&#39;, &#39;Shutdown\nJuly 2007&#39;, &#39;Shutdown\nOctober 2015&#39;])</span>

    <span class="c1">#plt.legend(prop={&#39;size&#39;: 12})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_mass_pu_prod_against_ratio</span><span class="p">(</span><span class="n">ratio_name</span><span class="p">,</span> <span class="n">sampled_ratio</span><span class="p">,</span> <span class="n">mass_pu_prod</span><span class="p">):</span>

    <span class="n">Pu_isotopes</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Pu_isotopes_name</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pu_isotopes</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampled_ratio</span><span class="p">,</span> <span class="n">mass_pu_prod</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">Pu_isotopes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mass [g]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> evolution&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio_name</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># To force scientific notation in each tick</span>
<span class="k">class</span> <span class="nc">MathTextSciFormatter</span><span class="p">(</span><span class="n">mticker</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%1.2e</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">%</span> <span class="n">x</span>
        <span class="n">decimal_point</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">positive_sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
        <span class="n">significand</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">decimal_point</span><span class="p">)</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">positive_sign</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exponent</span><span class="p">:</span>
            <span class="n">exponent</span> <span class="o">=</span> <span class="s1">&#39;10^{</span><span class="si">%s%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">exponent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">significand</span> <span class="ow">and</span> <span class="n">exponent</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span>  <span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">{\times}</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">significand</span><span class="p">,</span> <span class="n">exponent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span>  <span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">significand</span><span class="p">,</span> <span class="n">exponent</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="c1">#N1972367430</span>

            









        










</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Julien de Troullioud de Lanversin

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30411614-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</body>
</html>