

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>onix.couple.couple_openmc &mdash; ONIX Documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #0d0d0d" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releasenotes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pythonapi/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License Agreement</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ONIX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>onix.couple.couple_openmc</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for onix.couple.couple_openmc</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">openmc</span>
<span class="kn">import</span> <span class="nn">openmc.mgxs</span> <span class="k">as</span> <span class="nn">mgxs</span>
<span class="kn">from</span> <span class="nn">onix.cell</span> <span class="kn">import</span> <span class="n">Cell</span>
<span class="kn">from</span> <span class="nn">onix.system</span> <span class="kn">import</span> <span class="n">System</span>
<span class="kn">from</span> <span class="nn">onix</span> <span class="kn">import</span> <span class="n">salameche</span>
<span class="kn">from</span> <span class="nn">.openmc_fix</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">onix</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">onix</span> <span class="kn">import</span> <span class="n">data</span>


<div class="viewcode-block" id="Couple_openmc"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc">[docs]</a><span class="k">class</span> <span class="nc">Couple_openmc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is used to execute coupled-mode simulations</span>

<span class="sd">    Through this class, the user can:</span>

<span class="sd">    - chose to parallelize the Monte Carlo simulations via the &quot;set_MPI&quot; method</span>

<span class="sd">    - set the nuclear data libraries to be used in the simulation</span>

<span class="sd">    - set the burnup/time sequence for the simulation</span>

<span class="sd">    - manually set the volume of each BUCells (note that by default, ONIX uses the OpenMC stochastic volume calculation</span>
<span class="sd">      to find the volume of each cell. However, this method might produce important errors on the volume and it is</span>
<span class="sd">      advised to set the volume manually)</span>
<span class="sd">    - select which of the Cells defined in the OpenMC input should be depleted (these cells will be known as BUCells)</span>
<span class="sd">    - select a list of nuclides in each BUCell which cross sections will be tallied. If the user does not specify any such list of nuclides, ONIX will by default tally the cross sections of all</span>
<span class="sd">      nuclides which data are found in the cross section library.</span>

<span class="sd">    The Couple_openmc class also takes care of the coupling between ONIX and OpenMC. At the beginning of a simulation,</span>
<span class="sd">    it imports certain initial parameters from the OpenMC input to ONIX such as the name of the BUCells and the initial</span>
<span class="sd">    nuclide densities of each BUCell. During the simulation, it makes sure that information such as the flux tallies,</span>
<span class="sd">    neutron spectrum tallies, the reaction rates and the updated nuclide densities are correctly transfered between the burnup</span>
<span class="sd">    module and the neutron transport module.</span>

<span class="sd">    The Couple_openmc class will also sample the isomeric branching ratios and (n,gamma) cross sections on the</span>
<span class="sd">    the same energy points to prepare for the calculations of one-group isomeric branching ratios.</span>

<span class="sd">    **IMPORTANT: the root cell in the OpenMC input should be named &quot;root cell&quot;**</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MC_input_path : str</span>
<span class="sd">        Specifies where the OpenMC input files in .xml format are located. This parameter should not be specified as ONIX cannot yet work without Python API.</span>

<span class="sd">    xs_mode : str</span>
<span class="sd">        Choice between &#39;constant lib&#39; and &#39;no constant lib&#39;. Default to &#39;no constant lib&#39;.</span>
<span class="sd">        &#39;constant lib&#39; indicates to ONIX that the user has provided a constant one-group cross section libraries to be used.</span>
<span class="sd">        &#39;no constant lib&#39; indicates to ONIX that it should use one-group cross section computed by OpenMC.</span>

<span class="sd">    MPI : str</span>
<span class="sd">        Choice between &#39;on&#39; and &#39;off&#39;.</span>
<span class="sd">        Indicates whether OpenMC will be parrallelized or not.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="c1"># One-group energy bin</span>
    <span class="n">energy_bin</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">EnergyFilter</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">20.0e6</span><span class="p">])</span>

    <span class="c1"># Multigroup energy bin</span>
    <span class="n">minorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
    <span class="n">maxorder</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">mg_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">minorder</span><span class="p">,</span> <span class="n">maxorder</span><span class="p">,</span> <span class="p">(</span><span class="n">maxorder</span> <span class="o">-</span> <span class="n">minorder</span><span class="p">)</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mg_energy_mid_points</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mg_energy</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">mg_energy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
    <span class="c1">#mg_energy = np.logspace(-3, 7, num=300, base=10.0)</span>
    <span class="n">mg_energy_bin</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">EnergyFilter</span><span class="p">(</span><span class="n">mg_energy</span><span class="p">)</span>

    <span class="n">zero_dens_1_atm</span> <span class="o">=</span> <span class="mf">1E-24</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MC_input_path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xs_mode</span> <span class="o">=</span> <span class="s1">&#39;no constant lib&#39;</span><span class="p">,</span> <span class="n">MPI</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="c1"># If no MC_input_path is input, it is set to cwd</span>
        <span class="k">if</span> <span class="n">MC_input_path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">MC_input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MC_input_path</span> <span class="o">=</span> <span class="n">MC_input_path</span>

        <span class="c1"># If no mode is input by the user, mode is set by default to &#39;const_lib&#39;</span>
        <span class="k">if</span> <span class="n">xs_mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xs_mode</span> <span class="o">==</span> <span class="s1">&#39;constant lib&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_mode</span> <span class="o">=</span> <span class="n">xs_mode</span>

        <span class="c1"># # If MPI is not set to on by the user, MPI is set to off</span>
        <span class="c1"># if MPI == None:</span>
        <span class="c1">#   MPI == &#39;off&#39;</span>
        <span class="c1"># self._MPI = MPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_volume_set</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>

        <span class="c1"># List of selected cells to deplete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_name_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Dict of selected cells to deplete with their user defined nucl list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_fy_lib_set</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_fy_lib_set</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complete_user_fy_lib</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complete_fy_lib</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_set</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_lib_set</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_isomeric_branching_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_ng_cross_section_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># This is the path set in OpenMC for the hdf5 point-wise cross sections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cross_sections_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_openmc_bin_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># By default all available isomeric branching ratio are calculated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_few_isomeric</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span>

        <span class="c1"># By default, ONIX does not compute reactions rates ranking (it takes a lot of memory)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reac_rank</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span>

        <span class="c1"># Old way of defaulting MC_input_path to cwd</span>
        <span class="c1"># if args:</span>
        <span class="c1">#   self._MC_input_path = arg[0]</span>
        <span class="c1"># else:</span>
        <span class="c1">#   self._MC_input_path = os.getcwd()</span>

<span class="c1"># This method is used within the code to create a new material that is </span>
<span class="c1">#  uniquely associated to a particular cell</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">MC_input_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the path to OpenMC input files.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MC_input_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xs_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the mode for cross sections library.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xs_mode</span>
    
    <span class="c1"># @property</span>
    <span class="c1"># def nucl_list_dict(self):</span>

    <span class="c1">#   return self._nucl_list_dict</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the root cell as define in the OpenMC geometry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_cell</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">MPI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns wether MPI is activated or not (&#39;on&#39; if the user chose to parallelize OpenMC with MPI, &#39;off&#39; if not)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span>

<div class="viewcode-block" id="Couple_openmc.set_MPI"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_MPI">[docs]</a>    <span class="k">def</span> <span class="nf">set_MPI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execu</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the settings for the MPI parallelization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        execu : str</span>
<span class="sd">            The MPI execute command, for example &#39;srun&#39; on cluster using slurm</span>

<span class="sd">        tasks : str</span>
<span class="sd">            The number of tasks to parallelize&quot;&quot;&quot;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="n">tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exec</span> <span class="o">=</span> <span class="n">execu</span></div>

<div class="viewcode-block" id="Couple_openmc.few_isomeric_on"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.few_isomeric_on">[docs]</a>    <span class="k">def</span> <span class="nf">few_isomeric_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calling this function will force ONIX to only calculate isomeric branching ratios of Pm147 and Am241</span>
<span class="sd">        By default ONIX calculates all isomeric branching ratios for which data</span>
<span class="sd">        can be found in the EAF-2010 multiplicities library</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_few_isomeric</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reac_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reac_rank</span>
    
<div class="viewcode-block" id="Couple_openmc.reac_rank_on"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.reac_rank_on">[docs]</a>    <span class="k">def</span> <span class="nf">reac_rank_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calling this function will tell ONIX to produce reaction rates ranking and print them for each BUCells</span>
<span class="sd">        By default ONIX does not produce reaction rates ranking as it takes a lot of memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reac_rank</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span></div>

<div class="viewcode-block" id="Couple_openmc.select_bucells"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.select_bucells">[docs]</a>    <span class="k">def</span> <span class="nf">select_bucells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucell_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects the cells from the OpenMC input that should be depleted.</span>

<span class="sd">        The user can choose to specify the nuclides for which cross sections should be updated by OpenMC simulations. To do so, the user must enter a tuple where the first </span>
<span class="sd">        element is the OpenMC cell object and the second element is a list of the name of nuclides </span>
<span class="sd">        which cross sections should be updated.</span>

<span class="sd">        If the user does not specify for which nuclides cross sections should be updated,</span>
<span class="sd">        only the OpenMC cell objects should be entered. ONIX will by default calculate the cross sections</span>
<span class="sd">        for all nuclides available in the cross section library.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bucell_list: list of openmc.Cell or list of tuples</span>
<span class="sd">            Defines the list of cells that should be depleted by ONIX.</span>

<span class="sd">            For example, the user can set *bucell_list = [(fuel_cell, [&#39;U-235&#39;, &#39;Pu-239&#39;], (cladding_cell, [&#39;Al-27&#39;])]*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_name_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">bucell_list</span><span class="p">:</span>
            <span class="c1"># If this element is a tuple (bucell , nucl list)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>   
                <span class="n">bucell_name</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bucell_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span><span class="p">[</span><span class="n">bucell_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_nucl_to_be_tallied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucell</span><span class="p">):</span>

        <span class="c1"># If the user has provided a list of nuclide to be tallied</span>
        <span class="k">if</span> <span class="n">bucell</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span><span class="p">:</span>
            <span class="n">nucl_list_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span><span class="p">[</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nucl_list_input</span> <span class="o">==</span> <span class="s1">&#39;initial nuclides&#39;</span><span class="p">:</span>
                <span class="n">nucl_list</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">init_nucl</span>
            <span class="k">elif</span> <span class="n">nucl_list_input</span> <span class="o">==</span> <span class="s1">&#39;NAX&#39;</span><span class="p">:</span>
                <span class="n">NAX_nucl_list_name</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">zamid_list_to_name_list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">NAX_nucl_list</span><span class="p">)</span>
                <span class="n">NAX_nucl_list_name_new_format</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">bu_namelist_to_mc_namelist</span><span class="p">(</span><span class="n">NAX_nucl_list_name</span><span class="p">)</span>
                <span class="c1"># I add init_nucl because I believe it is important for init nuclides to be tallied</span>
                <span class="c1"># Their density is usually high enough that their change can influence spectrum etc...</span>
                <span class="n">nucl_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">NAX_nucl_list_name_new_format</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span><span class="p">]</span> <span class="o">+</span> <span class="n">bucell</span><span class="o">.</span><span class="n">init_nucl</span>
                <span class="c1"># Here we remove the potential duplicates</span>
                <span class="n">nucl_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">nucl_list</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nucl_list</span> <span class="o">=</span> <span class="n">nucl_list_input</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nucl_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span>

        <span class="k">return</span> <span class="n">nucl_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the system object of the simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_system</span>

    <span class="nd">@system</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the system object of the simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_system</span> <span class="o">=</span> <span class="n">system</span>
    

<div class="viewcode-block" id="Couple_openmc.import_openmc"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.import_openmc">[docs]</a>    <span class="k">def</span> <span class="nf">import_openmc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_cell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method import certain parameters from OpenMC to ONIX</span>

<span class="sd">        This method launches the _pre_run script which runs a first Monte Carlo</span>
<span class="sd">        simulation in order for ONIX to get a handle on the various OpenMC objects</span>
<span class="sd">        (this feature is essential when the user decides to defines input parameters</span>
<span class="sd">        via a text input file rather than using the Python API. However, as of now,</span>
<span class="sd">        ONIX only supports Python API input)</span>

<span class="sd">        The _pre_run script also requests OpenMC to calculate the volume of each OpenMC</span>
<span class="sd">        Cell with openmc.calculate_volume(). However, the volumes obtained</span>
<span class="sd">        via this method can have significant errors, especially for complex or large geometry.</span>
<span class="sd">        As of now, it is recommented that the user manually sets the volume of ech BUCell via</span>
<span class="sd">        the onix.couple.Couple_openmc.set_volume() command.</span>

<span class="sd">        Finally, a very important functionality of import_openmc is to add minute quantities</span>
<span class="sd">        of certain nuclides in BUCells&#39; materials so that OpenMC can calculate their cross sections.</span>
<span class="sd">        This means that ONIX is going to modify the material.xml and add all nuclides requested by the user</span>
<span class="sd">        for cross section calculations. This feature is necessary because OpenMC cannot tally reaction</span>
<span class="sd">        rates of nuclides that are not present in the material.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        root_cell: openmc.Cell</span>
<span class="sd">            Root cell object defined in OpenMC geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Printing of ONIX header here since this prerun will start OpenMC simulations</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">onix_header</span><span class="p">)</span>

        <span class="c1">#Instantiate a system</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reac_rank</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">reac_rank_on</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>

        <span class="c1"># read periodic surfaces  (openmc summary forgets the periodic surfaces coupling)</span>
        <span class="c1"># This function stores the periodic coupling of surfaces and it will be used later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_surfaces_dict</span> <span class="o">=</span> <span class="n">read_periodic_surfaces</span><span class="p">()</span>

        <span class="c1"># prerun to access cells and materials objects, to set cell volumes and if chosen</span>
        <span class="c1"># add 0 density nuclides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_run</span><span class="p">(</span><span class="n">root_cell</span><span class="p">)</span>

        <span class="n">bucell_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bucell_from_cell</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">bucell_dict</span> <span class="o">=</span> <span class="n">bucell_dict</span>
        <span class="n">system</span><span class="o">.</span><span class="n">bounding_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_box</span>

        <span class="c1"># reads, modifies and set settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_user_settings</span><span class="p">()</span>


        <span class="c1"># Move input files to input file folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_user_input_folder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_user_input</span><span class="p">()</span></div>

        <span class="c1"># MOVED TO OPENMC RUN</span>
        <span class="c1"># # New material xml file needs to be written with zero dens nuclides</span>
        <span class="c1"># self.export_material_to_xml()</span>
        <span class="c1"># # New geometry xml file needs to be written with new materials id</span>
        <span class="c1"># self.export_geometry_to_xml()</span>
        <span class="c1"># # Tallies xml files needs to be writen</span>
        <span class="c1"># self.export_tallies_to_xml()</span>
        <span class="c1"># # New settings xml files needs to be written</span>
        <span class="c1"># self.export_settings_to_xml()</span>

    <span class="c1"># Proably for when onix pass dens to OpenMC</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the bounding box of the geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_box</span>
     
<div class="viewcode-block" id="Couple_openmc.set_bounding_box"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_bounding_box">[docs]</a>    <span class="k">def</span> <span class="nf">set_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">ur</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the bounding box of the geometry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ll: [x,y,z]</span>
<span class="sd">            Extremity of the box located in the negative part of a 3-D plan</span>
<span class="sd">        ur: [x,y,z]</span>
<span class="sd">            Extremity of the box located in the positive part of a 3-D plan</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_box</span> <span class="o">=</span> <span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">ur</span><span class="p">]</span></div>

    <span class="c1"># def _set_material_nuclides(self, cell):</span>

    <span class="c1">#   cell_id = cell.id</span>
    <span class="c1">#   passlist = cell.passlists</span>
    <span class="c1">#   total_dens = cell.total_dens</span>

    <span class="c1">#   material = openmc.Material(cell_id)</span>

    <span class="c1">#   material.set_density(&#39;atom/b-cm&#39;, total_dens)</span>

    <span class="c1">#   for nuc in passlist:</span>

    <span class="c1">#       nuc_name = nuc.name.replace(&#39;-&#39;, &#39;&#39;)</span>
    <span class="c1">#       nuc_ao = nuc.dens/total_dens</span>
    <span class="c1">#       material.add_nuclide(nuc_name,  nuc_ao)</span>

    <span class="c1"># Osbolete</span>
    <span class="c1"># def set_settings(self, settings, init_dist):</span>
    <span class="c1"># # OpenMC simulation parameters</span>
    <span class="c1">#   batches = settings[&#39;batches&#39;]</span>
    <span class="c1">#   inactive = settings[&#39;inactive&#39;] </span>
    <span class="c1">#   particles = settings[&#39;particles&#39;]</span>

    <span class="c1">#   # Instantiate a Settings object</span>
    <span class="c1">#   settings_file = openmc.Settings()</span>
    <span class="c1">#   settings_file.batches = batches</span>
    <span class="c1">#   settings_file.inactive = inactive</span>
    <span class="c1">#   settings_file.particles = particles</span>
    <span class="c1">#   settings_file.output = {&#39;tallies&#39;: True}</span>

    <span class="c1">#   # Create an initial uniform spatial source distribution over fissionable zones</span>
    <span class="c1">#   init_dist = setting.init_dist</span>
    <span class="c1">#   shape = init_dist[&#39;shape&#39;]</span>
    <span class="c1">#   low_left_bound = init_dist[&#39;low_left&#39;]</span>
    <span class="c1">#   up_right_bound = init_dist[&#39;up_right&#39;]</span>
    <span class="c1">#   if shape == &#39;Box&#39;:</span>
    <span class="c1">#       uniform_dist = openmc.stats.Box(low_left_bound, up_right_bound, only_fissionable=True)</span>
    <span class="c1">#   settings_file.source = openmc.source.Source(space=uniform_dist)</span>

    <span class="c1">#   # Export to &quot;settings.xml&quot;</span>
    <span class="c1">#   settings_file.export_to_xml()</span>

    <span class="k">def</span> <span class="nf">_gen_user_input_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">gen_folder</span><span class="p">(</span><span class="s1">&#39;user_input&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_user_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">MC_input_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_input_path</span>
        <span class="n">user_input_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/user_input&#39;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">MC_input_path</span> <span class="o">+</span> <span class="s1">&#39;/geometry.xml&#39;</span><span class="p">,</span> <span class="n">user_input_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/geometry.xml&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">MC_input_path</span> <span class="o">+</span> <span class="s1">&#39;/materials.xml&#39;</span><span class="p">,</span> <span class="n">user_input_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/materials.xml&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">MC_input_path</span> <span class="o">+</span> <span class="s1">&#39;/settings.xml&#39;</span><span class="p">,</span> <span class="n">user_input_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/settings.xml&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pre_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_cell</span><span class="p">):</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;=== OpenMC pre-run ===</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">MC_input_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_input_path</span>
        <span class="n">pre_run_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span><span class="s1">&#39;/pre_run&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">pre_run_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pre_run_path</span><span class="p">)</span>

        <span class="c1"># Prepare the volume calculation</span>
        <span class="c1">#bounding_box = root_cell.bounding_box</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">root_cell</span><span class="o">.</span><span class="n">get_all_cells</span><span class="p">()</span>
        <span class="n">cell_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cell_dict_to_cell_list</span><span class="p">(</span><span class="n">cell_dict</span><span class="p">)</span>
        <span class="n">cell_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_cell</span><span class="p">)</span> <span class="c1"># Add root_cell so that the total volume is calculated</span>
        <span class="n">vol1</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">VolumeCalculation</span><span class="p">(</span><span class="n">cell_list</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">lower_left</span> <span class="o">=</span> <span class="n">ll</span><span class="p">,</span> <span class="n">upper_right</span> <span class="o">=</span> <span class="n">ur</span><span class="p">)</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">volume_calculations</span> <span class="o">=</span> <span class="p">[</span><span class="n">vol1</span><span class="p">]</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">run_mode</span><span class="o">=</span><span class="s1">&#39;volume&#39;</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">pre_run_path</span> <span class="o">+</span> <span class="s1">&#39;/settings.xml&#39;</span><span class="p">)</span>

        <span class="c1"># Copy the geometry and material file to the new dummy dir</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">MC_input_path</span> <span class="o">+</span> <span class="s1">&#39;/geometry.xml&#39;</span><span class="p">,</span> <span class="n">pre_run_path</span> <span class="o">+</span> <span class="s1">&#39;/geometry.xml&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">MC_input_path</span> <span class="o">+</span> <span class="s1">&#39;/materials.xml&#39;</span><span class="p">,</span> <span class="n">pre_run_path</span> <span class="o">+</span> <span class="s1">&#39;/materials.xml&#39;</span><span class="p">)</span>

        <span class="c1"># By default, the openm_exec is set to &#39;openmc&#39;</span>
        <span class="c1"># For some reasons, this does not work on the cluster (della)</span>
        <span class="c1"># On della, we need to explicitly define the absolute path to the bin we want to use</span>

        <span class="c1"># If the user has not define the bin path, we assume the simulation is not on a cluster</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmc_bin_path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">openmc</span><span class="o">.</span><span class="n">calculate_volumes</span><span class="p">(</span><span class="n">cwd</span> <span class="o">=</span> <span class="n">pre_run_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">openmc</span><span class="o">.</span><span class="n">calculate_volumes</span><span class="p">(</span><span class="n">cwd</span> <span class="o">=</span> <span class="n">pre_run_path</span><span class="p">,</span> <span class="n">openmc_exec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">openmc_bin_path</span><span class="p">)</span>

        <span class="c1"># Read and set initial nuclides dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_init_nucl_dict</span><span class="p">(</span><span class="n">root_cell</span><span class="p">)</span>

        <span class="c1"># # Read each material object and add 1atm nuclides chosen by the user</span>
        <span class="c1"># if self.mode == &#39;no_const_lib&#39;:</span>
        <span class="c1">#   self.add_zero_dens_nuclides(self.nucl_list_dict)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_initial_summary</span><span class="p">(</span><span class="n">pre_run_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cross_sections_path</span><span class="p">(</span><span class="n">pre_run_path</span><span class="p">)</span>
        <span class="c1"># Read cross sections xml files, create MC_XS_nucl_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_MC_XS_nucl_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_root_universe</span><span class="p">()</span>
        <span class="n">root_cell_name</span> <span class="o">=</span> <span class="s1">&#39;root cell&#39;</span> <span class="c1">#  need to be specified by the user at some point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_root_cell</span><span class="p">(</span><span class="n">root_cell_name</span><span class="p">)</span>

        <span class="c1"># Extract cells from summary, add 1 atm nuclides to their material</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change_cell_materials</span><span class="p">()</span>

        <span class="c1"># Read and distribute volumes to cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_vol_to_cell</span><span class="p">(</span><span class="n">vol1</span><span class="p">,</span> <span class="n">pre_run_path</span><span class="p">)</span>

        <span class="c1"># pdb.set_trace()</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">pre_run_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_vol_to_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol1</span><span class="p">,</span> <span class="n">pre_run_path</span><span class="p">):</span>

        <span class="n">root_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_cell</span>
        <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">root_cell</span><span class="o">.</span><span class="n">get_all_cells</span><span class="p">()</span>
        <span class="n">cell_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cell_dict_to_cell_list</span><span class="p">(</span><span class="n">cell_dict</span><span class="p">)</span>
        <span class="n">vol2</span> <span class="o">=</span> <span class="n">vol1</span><span class="o">.</span><span class="n">from_hdf5</span><span class="p">(</span><span class="n">pre_run_path</span> <span class="o">+</span> <span class="s1">&#39;/volume_1.h5&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cell_list</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">add_volume_information</span><span class="p">(</span><span class="n">vol2</span><span class="p">)</span>

        <span class="c1"># Add volume for the root cell too and set it to system</span>
        <span class="n">root_cell</span><span class="o">.</span><span class="n">add_volume_information</span><span class="p">(</span><span class="n">vol2</span><span class="p">)</span>

        <span class="c1"># This is now done in pass_vol when user does not define vol manually</span>
        <span class="c1"># system = self.system</span>
        <span class="c1"># system.total_vol = root_cell.volume</span>



    <span class="c1"># About summary</span>
    <span class="c1"># There are two type of OpenMC summary stored in onix: initial_summary and updated_summary</span>
    <span class="c1"># I have noticed that updating the initial summary was causing some problem in onix, i.e., the material xml file</span>
    <span class="c1"># would not update the density. The material was updating densities normaly when relying on the initial summary</span>
    <span class="c1"># A temporary solution for that is to separate the initial summary (that will be used to set dens to cells) and the</span>
    <span class="c1"># updated summary that will be used to extract densities to get 1g xs for bucells</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">initial_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the original summary.h5 file created by OpenMC before ONIX applies change to OpenMC&#39;s objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_summary</span>
    
    <span class="k">def</span> <span class="nf">_set_initial_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>

        <span class="n">initial_summary</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Summary</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/summary.h5&#39;</span><span class="p">)</span>

        <span class="c1">######### OpenMC Summary src does not close the hdf5 file it opens</span>
        <span class="c1">######### When onix tries to shutil.rmtree the pre_run folder, it can&#39;t because</span>
        <span class="c1">######### a stream to summary.h5 is still open</span>
        <span class="c1">######### We therefore close it here</span>
        <span class="c1">######### !!!! This should be modified in OpenMC at some points ###########</span>
        <span class="n">initial_summary</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">######### !!!! This should be modified in OpenMC at some points ###########</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_summary</span> <span class="o">=</span> <span class="n">initial_summary</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">updated_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the updated summary.h5 file created by OpenMC before ONIX applies change to OpenMC&#39;s objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updated_summary</span>
    
    <span class="k">def</span> <span class="nf">_set_updated_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>

        <span class="n">updated_summary</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Summary</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/summary.h5&#39;</span><span class="p">)</span>

        <span class="c1">######### OpenMC Summary src does not close the hdf5 file it opens</span>
        <span class="c1">######### When onix tries to shutil.rmtree the pre_run folder, it can&#39;t because</span>
        <span class="c1">######### a stream to summary.h5 is still open</span>
        <span class="c1">######### We therefore close it here</span>
        <span class="c1">######### !!!! This should be modified in OpenMC at some points ###########</span>
        <span class="n">updated_summary</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">######### !!!! This should be modified in OpenMC at some points ###########</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_updated_summary</span> <span class="o">=</span> <span class="n">updated_summary</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">statepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statepoint</span>

    <span class="k">def</span> <span class="nf">_set_statepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>

        <span class="n">file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;statepoint&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">st_name</span> <span class="o">=</span> <span class="n">file</span>
        <span class="n">statepoint</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">StatePoint</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statepoint</span> <span class="o">=</span> <span class="n">statepoint</span>

    <span class="k">def</span> <span class="nf">_set_kinf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">statepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statepoint</span>
        <span class="n">kinf</span> <span class="o">=</span> <span class="n">statepoint</span><span class="o">.</span><span class="n">k_combined</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">sequence</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">_set_macrostep_kinf</span><span class="p">(</span><span class="n">kinf</span><span class="p">)</span>
    

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the root cell object created in the OpenMC geometry.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_cell</span>
    
    <span class="k">def</span> <span class="nf">_set_root_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_summary</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">root_universe</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">root_universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_universe</span> <span class="o">=</span> <span class="n">root_universe</span>

    <span class="k">def</span> <span class="nf">_set_root_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_cell_name</span><span class="p">):</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_summary</span>
        <span class="c1"># get_cells_by_name returns a list hence the index 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_cell</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_cells_by_name</span><span class="p">(</span><span class="n">root_cell_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">add_periodic_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_surfaces_dict</span><span class="p">)</span>

        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_cell</span><span class="o">.</span><span class="n">region</span>
        <span class="c1">#print (region.get_surfaces())</span>
        <span class="k">for</span> <span class="n">surface_id</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">get_surfaces</span><span class="p">():</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">get_surfaces</span><span class="p">()[</span><span class="n">surface_id</span><span class="p">]</span>

    <span class="c1"># While the most convenient way would be to extract path from summary.materials. It looks like</span>
    <span class="c1"># summary does not store the cross sections path in materials</span>
    <span class="k">def</span> <span class="nf">_set_cross_sections_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_run_path</span><span class="p">):</span>

        <span class="n">path_to_materials_xml</span> <span class="o">=</span> <span class="n">pre_run_path</span> <span class="o">+</span> <span class="s1">&#39;/materials.xml&#39;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">path_to_materials_xml</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;cross_sections&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cross_sections_path</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/cross_sections.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">materials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the materials object created in the OpenMC material input.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materials</span>
    
    <span class="k">def</span> <span class="nf">_change_cell_materials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_summary</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">materials</span>
        <span class="k">for</span> <span class="n">bucell_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_name_list</span><span class="p">:</span>
            <span class="c1"># If bucell should only tally initial nuclide, no need to add 1 atm nuclides</span>
            <span class="c1"># This caused the cell material branching issue discovered on Nov 2 2019</span>
            <span class="c1"># This is now commented out</span>
            <span class="c1"># if self.selected_bucells_nucl_list_dict != {}:</span>
            <span class="c1">#   if bucell_name in self.selected_bucells_nucl_list_dict:</span>
            <span class="c1">#       if self.selected_bucells_nucl_list_dict[bucell_name] == &#39;initial nuclides&#39;:</span>
            <span class="c1">#           continue</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_cells_by_name</span><span class="p">(</span><span class="n">bucell_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_zero_dens_nuclides</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>


    <span class="c1"># def _change_cells_materials(self):</span>

    <span class="c1">#   root_cell = self.root_cell</span>
    <span class="c1">#   print (root_cell)</span>
    <span class="c1">#   cell_dict = root_cell.get_all_cells()</span>
    <span class="c1">#   # materials with 1atm nuclides</span>
    <span class="c1">#   materials = self.materials</span>
    <span class="c1">#   for cell_id in cell_dict:</span>
    <span class="c1">#       cell = cell_dict[cell_id]</span>
    <span class="c1">#       cell.get_all_materials</span>
    <span class="c1">#       material_dict = cell.get_all_materials()</span>
    <span class="c1">#       material = material_dict[list(material_dict.keys())[0]]</span>
    <span class="c1">#       mat_name = material.name</span>
    <span class="c1">#       for new_mat in materials:</span>
    <span class="c1">#           if new_mat.name == mat_name:</span>
    <span class="c1">#               print(new_mat.get_nuclides(), material.get_nuclides())</span>



    <span class="c1"># Add zero dens nuclide for each material</span>
    <span class="k">def</span> <span class="nf">_add_zero_dens_nuclides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>

        <span class="n">material_dict</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get_all_materials</span><span class="p">()</span>

        <span class="c1"># A deepcopy of the object material is created and this copy will eventually overwrite the</span>
        <span class="c1"># original material that was filling the cell</span>
        <span class="c1"># If a deepcopy was not used:</span>
        <span class="c1"># -  when a material id is modified (branched out) vis-a-vis the hosting cell</span>
        <span class="c1"># the changes would also be applied on the original material object</span>
        <span class="c1"># However, this original material object might fill other cells which would mean that</span>
        <span class="c1"># when the loop goes to another cell with same material, the change are going to</span>
        <span class="c1"># cumulate</span>
        <span class="c1"># -  in addition, different cells with same initial material would still only have one common material object</span>
        <span class="c1"># (i.e. the branching out fails)</span>
        <span class="n">material</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">material_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">material_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>   

        <span class="n">init_nucl</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">get_nuclides</span><span class="p">()</span>
        <span class="n">cell_name</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">name</span>
        <span class="n">mat_name</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Not sure if this is necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="k">if</span> <span class="n">cell_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span><span class="p">:</span>
                <span class="n">nucl_list_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_nucl_list_dict</span><span class="p">[</span><span class="n">cell_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">nucl_list_input</span> <span class="o">==</span> <span class="s1">&#39;initial nuclides&#39;</span><span class="p">:</span>
                    <span class="n">nucl_list</span> <span class="o">=</span> <span class="n">init_nucl</span>
                <span class="k">elif</span> <span class="n">nucl_list_input</span> <span class="o">==</span> <span class="s1">&#39;NAX&#39;</span><span class="p">:</span>
                    <span class="n">NAX_nucl_list_name</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">zamid_list_to_name_list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">NAX_nucl_list</span><span class="p">)</span>
                    <span class="n">NAX_nucl_list_name_new_format</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">bu_namelist_to_mc_namelist</span><span class="p">(</span><span class="n">NAX_nucl_list_name</span><span class="p">)</span>
                    <span class="c1"># I add init_nucl because I believe it is important for init nuclides to be tallied</span>
                    <span class="c1"># Their density is usually high enough that their change can influence spectrum etc...</span>
                    <span class="n">nucl_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">NAX_nucl_list_name_new_format</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span><span class="p">]</span> <span class="o">+</span> <span class="n">init_nucl</span>
                    <span class="c1"># Here we remove the potential duplicates</span>
                    <span class="n">nucl_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">nucl_list</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                     <span class="n">nucl_list</span> <span class="o">=</span> <span class="n">nucl_list_input</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nucl_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span>
                <span class="c1">#nucl_list = utils.bu_namelist_to_mc_namelist(nucl_list)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">nucl_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_lista_in_listb</span><span class="p">(</span><span class="n">init_nucl</span><span class="p">,</span> <span class="n">nucl_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Initial_nuclides_not_in_nuclide_list</span><span class="p">(</span><span class="s1">&#39;Some initial nuclides in cell </span><span class="si">{}</span><span class="s1"> material </span><span class="si">{}</span><span class="s1"> are not included in nucl_list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell_name</span><span class="p">,</span> <span class="n">mat_name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">nucl</span> <span class="ow">in</span> <span class="n">nucl_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nucl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">init_nucl</span><span class="p">:</span>
                <span class="n">material</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">nucl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_dens_1_atm</span><span class="p">)</span>

        <span class="c1"># Material is rename &#39;cell name&#39; + &#39;mat&#39;</span>
        <span class="c1"># New material id is &#39;mat id&#39; + &#39;cell id&#39;</span>
        <span class="n">material</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> mat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell_name</span><span class="p">)</span>
        <span class="n">material</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="c1"># Here, we overwrite the original material object with a copy which id and name have been modified</span>
        <span class="c1"># to reflect the fact that this material object is specific to this cell</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">material</span>    

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the sequence assigned to the Couple_openmc() object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span>
    
    <span class="c1"># @sequence.setter</span>
    <span class="c1"># def sequence(self, sequence):</span>

    <span class="c1">#   self._sequence = sequence</span>

<div class="viewcode-block" id="Couple_openmc.set_sequence"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">set_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets a sequence object to the Couple_openmc object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sequence: onix.Sequence</span>
<span class="sd">            ONIX sequence object defined by the user.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_sequence</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;couple&#39;</span><span class="p">)</span></div>

    <span class="c1"># Add zero dens nuclide for each cell</span>
    <span class="c1"># Sort of complicated</span>
    <span class="c1"># Will deal with that later</span>
    <span class="c1"># def add_zero_dens_nuclides(self, root_cell, nucl_list_dict):</span>

    <span class="c1">#   cell_dict = root_cell.get_all_cells()</span>

    <span class="c1">#   for cell_id in cell_dict:</span>
    <span class="c1">#       cell = cell_dict[cell_id]</span>
    <span class="c1">#       material_dict = cell.get_all_materials()</span>
    <span class="c1">#       material = copy.deepcopy(material_dict[material_dict.key()[0]])</span>
    <span class="c1">#       init_nucl = material.get_nuclides()</span>
    <span class="c1">#       nucl_list = nucl_list_dict[cell_id]</span>
    <span class="c1">#       nucl_list = utils.bu_namelist_to_mc_namelist(nucl_list)</span>
    <span class="c1">#       if not is_lista_in_listb(init_nucl, nucl_list):</span>
    <span class="c1">#           raise Initial_nuclides_not_in_nuclide_list(&#39;Some initial nuclides of material {} are not included in nucl_list&#39;.format(mat_id))</span>
    <span class="c1">#       for nucl in nucl_list:</span>
    <span class="c1">#           if nucl not in init_nucl:</span>
    <span class="c1">#               material.add_nuclide(nucl, 1E-22)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">init_nucl_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_nucl_dict</span>

    <span class="c1"># Create a dict with initial nuclides of each cell before</span>
    <span class="c1"># cell material is added 1 atm nuclides</span>
    <span class="k">def</span> <span class="nf">_set_init_nucl_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_cell</span><span class="p">):</span>

        <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">root_cell</span><span class="o">.</span><span class="n">get_all_cells</span><span class="p">()</span>

        <span class="n">init_nucl_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cell_dict</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span>
            <span class="n">material_dict</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get_all_materials</span><span class="p">()</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">material_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">material_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">init_nucl</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">get_nuclides</span><span class="p">()</span>
            <span class="n">init_nucl_dict</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_nucl</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_nucl_dict</span> <span class="o">=</span> <span class="n">init_nucl_dict</span>

        <span class="c1"># # If no nucl list has been defined, nucl_list_dict = init_nucl</span>
        <span class="c1"># if self.nucl_list_dict == None:</span>
        <span class="c1">#   self.nucl_list_dict = self.init_nucl_dict</span>

    <span class="c1"># Use init_nucl_dict and distribute init_nucl to each bucell</span>
    <span class="k">def</span> <span class="nf">_set_init_nucl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_dict</span><span class="p">,</span> <span class="n">bucell_dict</span><span class="p">):</span>

        <span class="n">init_nucl_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_nucl_dict</span>
        <span class="k">for</span> <span class="n">bucell_id</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">bucell_id</span><span class="p">]</span>
            <span class="n">bucell</span><span class="o">.</span><span class="n">init_nucl</span> <span class="o">=</span> <span class="n">init_nucl_dict</span><span class="p">[</span><span class="n">bucell_id</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">MC_XS_nucl_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the list of nuclides for which cross section data exist in the cross section library.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MC_XS_nucl_list</span>

    <span class="nd">@MC_XS_nucl_list</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">MC_XS_nucl_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MC_XS_nucl_list</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_MC_XS_nucl_list</span> <span class="o">=</span> <span class="n">MC_XS_nucl_list</span>

    <span class="k">def</span> <span class="nf">_set_MC_XS_nucl_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1">#path_to_xs_xml = os.environ[&#39;OPENMC_CROSS_SECTIONS&#39;]</span>
        <span class="n">path_to_xs_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cross_sections_path</span> <span class="o">+</span> <span class="s1">&#39;/cross_sections.xml&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">path_to_xs_xml</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;neutron&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_MC_XS_nucl_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;materials&#39;</span><span class="p">])</span>

        <span class="c1"># Remove trouble makers that appears in JEFF32 cross section    </span>
        <span class="c1"># For some reason, OpenMC can&#39;t find these nuclides in jeff lib at 800K</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;Cu63&#39;)</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;Cu65&#39;)</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;Mn55&#39;)</span>
        <span class="c1"># # THose are not handled by onix</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;C0&#39;)</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;V0&#39;)</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;Zn0&#39;)</span>

        <span class="c1"># Remove trouble makers that appears in ENDFVIII cross section  </span>
        <span class="c1"># For some reason, OpenMC can&#39;t find these nuclides in jeff lib at 800K</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;Cu63&#39;)</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;Cu65&#39;)</span>
        <span class="c1"># self._MC_XS_nucl_list.remove(&#39;Mn55&#39;)</span>
        <span class="c1"># # THose are not handled by onix</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MC_XS_nucl_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MC_XS_nucl_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;V0&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MC_XS_nucl_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Zn0&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>



    <span class="c1"># When volume is passed from OpenMC to ONIX</span>
    <span class="k">def</span> <span class="nf">_pass_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_dict</span><span class="p">,</span> <span class="n">bucell_dict</span><span class="p">):</span>

        <span class="c1"># Need to loop over bucell_dict because there might be more cells than bucells</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>

            <span class="n">cell</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cell_volume</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">volume</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bucell</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">cell_volume</span>

        <span class="c1"># root_cell is not in bucell_dict but it contains the info on the total volume</span>
        <span class="c1"># Here, the total volume is set to system</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">system</span><span class="o">.</span><span class="n">total_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_cell</span><span class="o">.</span><span class="n">volume</span>

    <span class="c1"># When volume is set directly by user</span>
    <span class="c1"># Right now this should bet set after import openmc as it overwrites volume calculated by openmc</span>
<div class="viewcode-block" id="Couple_openmc.set_vol"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_vol">[docs]</a>    <span class="k">def</span> <span class="nf">set_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the volume of each BUCell in :math:`cm^{3}`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vol_dict: dict</span>
<span class="sd">            Dictionnary where keys are the names of BUCell (as defined by the user) and entries are volume in :math:`cm^{3}`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">bucell_dict</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">bucell_dict</span>

        <span class="c1"># Need to loop over bucell_dict because there might be more cells than bucells</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bucell</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">vol_dict</span><span class="p">:</span>
                <span class="n">bucell</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">vol_dict</span><span class="p">[</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># We treat total volume separately</span>
        <span class="n">system</span><span class="o">.</span><span class="n">total_vol</span> <span class="o">=</span> <span class="n">vol_dict</span><span class="p">[</span><span class="s1">&#39;total volume&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_volume_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span></div>


    <span class="k">def</span> <span class="nf">_pass_nuclide_densities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_dict</span><span class="p">,</span> <span class="n">bucell_dict</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1">#init_nucl = self.init_nucl_dict[i]</span>
            <span class="n">init_nucl</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">init_nucl</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get_all_materials</span><span class="p">()</span>
            <span class="n">openmc_dens_dict</span> <span class="o">=</span> <span class="n">materials</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">materials</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_nuclide_atom_densities</span><span class="p">()</span>
            <span class="n">onix_dens_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">nucl</span> <span class="ow">in</span> <span class="n">openmc_dens_dict</span><span class="p">:</span>
                <span class="c1">#OpenMC xs has cross section for element carbon and Vanadinium (C0, V0) only. onix can&#39;t handle that</span>
                <span class="k">if</span> <span class="n">nucl</span> <span class="o">==</span> <span class="s1">&#39;C0&#39;</span> <span class="ow">or</span> <span class="n">nucl</span> <span class="o">==</span> <span class="s1">&#39;V0&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">onix_nucl</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">openmc_name_to_onix_name</span><span class="p">(</span><span class="n">nucl</span><span class="p">)</span>
                <span class="c1"># if nucl is one of the initial non-zero initial nuclide, pass the density</span>
                <span class="k">if</span> <span class="n">nucl</span> <span class="ow">in</span> <span class="n">init_nucl</span><span class="p">:</span>
                    <span class="n">onix_dens_dict</span><span class="p">[</span><span class="n">onix_nucl</span><span class="p">]</span> <span class="o">=</span> <span class="n">openmc_dens_dict</span><span class="p">[</span><span class="n">nucl</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># if nucl is not one of the non-zero initial nuclide, set densiy to zero</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">onix_dens_dict</span><span class="p">[</span><span class="n">onix_nucl</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bucell</span><span class="o">.</span><span class="n">set_initial_dens</span><span class="p">(</span><span class="n">onix_dens_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_bucell_from_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">root_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_cell</span>
        <span class="n">bucell_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">root_cell</span><span class="o">.</span><span class="n">get_all_cells</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cell_dict</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cell_name</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">cell_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_bucells_name_list</span><span class="p">:</span>            
                <span class="n">bucell_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cell_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_init_nucl</span><span class="p">(</span><span class="n">cell_dict</span><span class="p">,</span> <span class="n">bucell_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pass_vol</span><span class="p">(</span><span class="n">cell_dict</span><span class="p">,</span> <span class="n">bucell_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pass_nuclide_densities</span><span class="p">(</span><span class="n">cell_dict</span><span class="p">,</span> <span class="n">bucell_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bucell_dict</span>


    <span class="k">def</span> <span class="nf">_get_flux_tally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucell</span><span class="p">):</span>

        <span class="n">flux</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> flux&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">openmc</span><span class="o">.</span><span class="n">CellFilter</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_bin</span><span class="p">)</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">flux</span>

    <span class="k">def</span> <span class="nf">_get_flux_spectrum_tally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucell</span><span class="p">):</span>

        <span class="n">flux_spectrum</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> flux spectrum&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">flux_spectrum</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">openmc</span><span class="o">.</span><span class="n">CellFilter</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
        <span class="n">flux_spectrum</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mg_energy_bin</span><span class="p">)</span>
        <span class="n">flux_spectrum</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">flux_spectrum</span>

    <span class="c1"># Every nuclide presents in cell material will have its tally taken</span>
    <span class="c1"># (n,t) is tallied for all nuclides for the moment. It is surely more efficient to only tally it for Lithium</span>
    <span class="k">def</span> <span class="nf">_get_all_nucl_rxn_tally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucell</span><span class="p">):</span>

        <span class="n">nucl_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nucl_to_be_tallied</span><span class="p">(</span><span class="n">bucell</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;bucell name&#39;</span><span class="p">,</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;nucl list when set to tally&#39;</span><span class="p">,</span><span class="n">nucl_list</span><span class="p">)</span>
        <span class="n">nucl_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">bu_namelist_to_mc_namelist</span><span class="p">(</span><span class="n">nucl_list</span><span class="p">)</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> rxn rate&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">rxn</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">openmc</span><span class="o">.</span><span class="n">CellFilter</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
        <span class="n">rxn</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_bin</span><span class="p">)</span>
        <span class="n">rxn</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fission&#39;</span><span class="p">,</span> <span class="s1">&#39;(n,gamma)&#39;</span><span class="p">,</span> <span class="s1">&#39;(n,2n)&#39;</span><span class="p">,</span> <span class="s1">&#39;(n,3n)&#39;</span><span class="p">,</span> <span class="s1">&#39;(n,p)&#39;</span><span class="p">,</span> <span class="s1">&#39;(n,a)&#39;</span><span class="p">,</span> <span class="s1">&#39;(n,t)&#39;</span><span class="p">]</span>
        <span class="c1">#rxn.scores = [&#39;fission&#39;, &#39;(n,gamma)&#39;]</span>
        <span class="c1">#rxn.scores = [&#39;fission&#39;, &#39;(n,gamma)&#39;, &#39;(n,2n)&#39;]</span>
        <span class="n">rxn</span><span class="o">.</span><span class="n">nuclides</span> <span class="o">=</span> <span class="n">nucl_list</span>
        
        <span class="k">return</span> <span class="n">rxn</span>

    <span class="c1"># Tally dedicated to production reaction rate for tritium</span>
    <span class="c1"># Only Lithium6 and Berylium10 are non-negligible tritium producer nuclides through (n,t)</span>
    <span class="c1"># def get_H3_rxn_tally(self, bucell):</span>

    <span class="c1">#   print (&#39;Creating H3 rxn rate tally&#39;)</span>
    <span class="c1">#   H3_rxn = openmc.Tally(name=&#39;{} H3 rxn rate&#39;.format(bucell.name))</span>
    <span class="c1">#   H3_rxn.filters = [openmc.CellFilter(bucell.id)]</span>
    <span class="c1">#   H3_rxn.filters.append(self.energy_bin)</span>
    <span class="c1">#   H3_rxn.scores = [&#39;(n,t)&#39;]</span>
    <span class="c1">#   #rxn.scores = [&#39;fission&#39;, &#39;(n,gamma)&#39;]</span>
    <span class="c1">#   #rxn.scores = [&#39;fission&#39;, &#39;(n,gamma)&#39;, &#39;(n,2n)&#39;]</span>
    <span class="c1">#   H3_rxn.nuclides = [&#39;Li6&#39;, &#39;Be10&#39;]</span>
        
    <span class="c1">#   return H3_rxn</span>

    <span class="k">def</span> <span class="nf">_export_material_to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Collect materials from each cells and put them into a materials object</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Materials</span><span class="p">()</span>
        <span class="n">root_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_cell</span>
        <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">root_cell</span><span class="o">.</span><span class="n">get_all_cells</span><span class="p">()</span>
        <span class="c1"># When different cells have the same material, the material should not be</span>
        <span class="c1"># counted twice</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cell_dict</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span>
            <span class="n">material_dict</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get_all_materials</span><span class="p">()</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">material_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">material_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">material</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">:</span>
                <span class="n">materials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
                <span class="n">id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># If the input materials.xml file is in cwd, remove it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/materials.xml&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Set the cross section path again to materials</span>
        <span class="n">materials</span><span class="o">.</span><span class="n">cross_sections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cross_sections_path</span> <span class="o">+</span><span class="s1">&#39;/cross_sections.xml&#39;</span>

        <span class="n">materials</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_export_geometry_to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Collect each cells and put them into a geometry object</span>
        <span class="c1"># Need to re-instantiate a universe that will be filled with the modified root cell</span>
        <span class="n">root_universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_universe</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">root_universe</span><span class="p">)</span>

        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_cell</span><span class="o">.</span><span class="n">region</span>
        <span class="c1">#print (region.get_surfaces())</span>
        <span class="k">for</span> <span class="n">surface_id</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">get_surfaces</span><span class="p">():</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">get_surfaces</span><span class="p">()[</span><span class="n">surface_id</span><span class="p">]</span>
        <span class="c1">#quit()</span>

        <span class="c1"># If the input materials.xml file is in cwd, remove it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/geometry.xml&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">geometry</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_export_tallies_to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>

        <span class="n">bucell_dict</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">bucell_dict</span>

        <span class="n">tallies</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tallies</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">bucell_id</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">bucell_id</span><span class="p">]</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flux_tally</span><span class="p">(</span><span class="n">bucell</span><span class="p">)</span>
            <span class="n">flux_spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flux_spectrum_tally</span><span class="p">(</span><span class="n">bucell</span><span class="p">)</span>
            <span class="n">rxn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_nucl_rxn_tally</span><span class="p">(</span><span class="n">bucell</span><span class="p">)</span>
            <span class="c1"># H3_rxn = self.get_H3_rxn_tally(bucell)</span>
            <span class="n">tallies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">tallies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_spectrum</span><span class="p">)</span>
            <span class="n">tallies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
            <span class="c1"># tallies.append(H3_rxn)</span>

        <span class="c1"># If the input tallies.xml file is in cwd, remove it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/tallies.xml&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">tallies</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>

    <span class="c1"># settings.xml as provided by the user is read</span>
    <span class="c1"># It is then modified and set to couple</span>
    <span class="c1"># Since it will not change during the simulation, it is not going</span>
    <span class="c1"># to be modified again</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the setting object defined in OpenMC simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span>

    <span class="k">def</span> <span class="nf">_read_user_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">MC_input_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_input_path</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">MC_input_path</span> <span class="o">+</span> <span class="s1">&#39;/settings.xml&#39;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;particles&#39;</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">partices</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;batches&#39;</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;inactive&#39;</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">inactive</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inactive</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">settings</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tallies&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;interpolation&#39;</span><span class="p">}</span>

        <span class="n">ll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#uniform_dist = openmc.stats.Box(ll, ur, only_fissionable=True)</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="n">point</span><span class="p">)</span>
        <span class="c1"># To reduce the size of the statepoint file</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">sourcepoint</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">settings</span>


    <span class="c1"># the setting file created by the user should be stored somewhere</span>
    <span class="k">def</span> <span class="nf">_export_settings_to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span>

        <span class="c1"># If the input settings.xml file is in cwd, remove it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/settings.xml&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">settings</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particles</span>

    <span class="nd">@particles</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_particles</span> <span class="o">=</span> <span class="n">particles</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">batches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span>

    <span class="nd">@batches</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="o">=</span> <span class="n">batches</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inactive</span>

    <span class="nd">@inactive</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inactive</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inactive</span> <span class="o">=</span> <span class="n">inactive</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">openmc_bin_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the path to OpenMC executable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openmc_bin_path</span>

    <span class="nd">@openmc_bin_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">openmc_bin_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openmc_bin_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the path to OpenMC executable. It seems that in certain environement (such as HPC clusters), openmc.run() is unable to find the path to OpenMC executable. Defining the path explicitly here avoid this problem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        openmc_bin_path: str</span>
<span class="sd">            The path to OpenMC executable</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_openmc_bin_path</span> <span class="o">=</span> <span class="n">openmc_bin_path</span>

    <span class="k">def</span> <span class="nf">_run_openmc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># New material xml file needs to be written with zero dens nuclides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_material_to_xml</span><span class="p">()</span>
        <span class="c1"># New geometry xml file needs to be written with new materials id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_geometry_to_xml</span><span class="p">()</span>
        <span class="c1"># Tallies xml files needs to be writen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_tallies_to_xml</span><span class="p">()</span>
        <span class="c1"># Settings xml files needs to be written</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_settings_to_xml</span><span class="p">()</span>

        <span class="c1">#openmc_bin_path = &#39;/tigress/jdtdl/openmc/py3-mpi-190324/bin/openmc&#39;</span>
        <span class="c1">#openpc_bin_path = &#39;/tigress/mkutt/openmc/py3-mpi/bin/openmc&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmc_bin_path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">openmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">mpi_args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">openmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">mpi_args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">],</span> <span class="n">openmc_exec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmc_bin_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmc_bin_path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">openmc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">openmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">openmc_exec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmc_bin_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_statepoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_updated_summary</span><span class="p">()</span>
        <span class="c1"># Append the new kinf to system sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_kinf</span><span class="p">()</span>

    <span class="c1"># This method set decay_lib_set to yes</span>
    <span class="c1"># It can be used when the user does not want the system to be set any decay data</span>
<div class="viewcode-block" id="Couple_openmc.no_decay"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.no_decay">[docs]</a>    <span class="k">def</span> <span class="nf">no_decay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Activate a &quot;no-decay&quot; simulation. This means that the system will not model the decay of nuclides</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span></div>

<div class="viewcode-block" id="Couple_openmc.set_decay_lib"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_decay_lib">[docs]</a>    <span class="k">def</span> <span class="nf">set_decay_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decay_lib_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the decay library to use for ONIX.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        decay_lib_path: str</span>
<span class="sd">            Path to a decay library. The library needs to be in ONIX format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_path</span> <span class="o">=</span> <span class="n">decay_lib_path</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_decay_for_all</span><span class="p">(</span><span class="n">decay_lib_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Couple_openmc.set_default_decay_lib"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_default_decay_lib">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_decay_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the decay library to the default one (ENDF/B-VIII.0).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="c1">#system.set_default_decay_for_all_no_add()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_path</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_default_decay_for_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Couple_openmc.set_decay_from_object"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_decay_from_object">[docs]</a>    <span class="k">def</span> <span class="nf">set_decay_from_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucell</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the decay library from an ONIX decay object defined by the user for a specific BUCell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bucell: onix.Cell</span>
<span class="sd">            The BUCell for which the decay data are to be used.</span>
<span class="sd">        object: onix.utils.decay_lib</span>
<span class="sd">            A decay library object constructed by the user with onix.utils.decay_lib.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="c1"># This should not set yes since it is only for one bucell</span>
        <span class="c1"># Need to be fixed later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="n">bucell</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_bucell</span><span class="p">(</span><span class="n">bucell</span><span class="p">)</span>
        <span class="n">bucell</span><span class="o">.</span><span class="n">set_decay</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span></div>

<div class="viewcode-block" id="Couple_openmc.set_xs_lib"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_xs_lib">[docs]</a>    <span class="k">def</span> <span class="nf">set_xs_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs_lib_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the cross section library to use for ONIX.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs_lib_path: str</span>
<span class="sd">            Path to a cross section library. The library needs to be in ONIX format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_xs_for_all</span><span class="p">(</span><span class="n">xs_lib_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Couple_openmc.set_default_xs_lib"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_default_xs_lib">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_xs_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the cross section library to the default one. The default cross section library in ONIX has been obtained by computing middle-burnup one-group cross section for a coupled simumation of a LWR fuel pin-cell. Therefore, this library is only adapted for LWR reactors.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="c1">#system.set_default_decay_for_all_no_add()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_default_xs_for_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Couple_openmc.set_user_fy_lib"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_user_fy_lib">[docs]</a>    <span class="k">def</span> <span class="nf">set_user_fy_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_fy_lib_path</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the fission yield library to use for ONIX. Setting the *complete* parameter to True allows ONIX to complement the data of the provided library with additional data found in ENDF/B-VIII.0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_fy_lib_path: str</span>
<span class="sd">            Path to a fission yield library. The library needs to be in ONIX format.</span>
<span class="sd">        complete: bool</span>
<span class="sd">            Indicates to ONIX whether or not to complement the provided library with additional fission yields from ENDF:B-VIII.0 library.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_fy_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="k">if</span> <span class="n">complete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete_user_fy_lib</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_fy_lib_path</span> <span class="o">=</span> <span class="n">user_fy_lib_path</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_fy_for_all</span><span class="p">(</span><span class="n">user_fy_lib_path</span><span class="p">,</span> <span class="n">complete</span><span class="p">)</span></div>

<div class="viewcode-block" id="Couple_openmc.set_default_fy_lib"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_default_fy_lib">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_fy_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the fission yield library to the default one (ENDF/B-VIII.0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_fy_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_fy_lib_path</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        <span class="c1">#system.set_default_fy_for_all_no_add()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_default_fy_for_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Couple_openmc.set_fy_from_object"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.set_fy_from_object">[docs]</a>    <span class="k">def</span> <span class="nf">set_fy_from_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucell</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the fission yield library to an ONIX fission yield object defined by the user for a specific BUCell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bucell: onix.Cell</span>
<span class="sd">            The BUCell for which the decay data are to be used.</span>
<span class="sd">        object: onix.utils.fy_lib</span>
<span class="sd">            A fission yield library object constructed by the user with onix.utils.fy_lib.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="c1"># This should not set yes since it is only for one bucell</span>
        <span class="c1"># Need to be fixed later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fy_lib_set</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="n">bucell</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_bucell</span><span class="p">(</span><span class="n">bucell</span><span class="p">)</span>
        <span class="n">bucell</span><span class="o">.</span><span class="n">set_fy</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span></div>


    <span class="c1"># This method reads, samples the isomeric branching data and xs data</span>
    <span class="c1"># using the mg energy bin mid points data and fold them together</span>
    <span class="c1"># def fold_sampled_isomeric_xs_data(self):</span>

    <span class="c1">#   sampled_iso_data = self.get_sampled_isomeric_branching_data()</span>
    <span class="c1">#   sampled_xs_data = self.get_sampled_ng_cross_section_data()</span>

    <span class="c1">#   iso_xs_data = {}</span>
    <span class="c1">#   for nucl in sampled_iso_data:</span>
    <span class="c1">#       iso_data = sampled_iso_data[nucl]</span>
    <span class="c1">#       xs_data = sampled_xs_data[nucl]</span>
    <span class="c1">#       iso_xs_data[nucl] = {}</span>
    <span class="c1">#       iso_xs_data[nucl][&#39;0&#39;] = [x*y for x,y in zip(iso_data[&#39;0&#39;], xs_data)]</span>
    <span class="c1">#       iso_xs_data[nucl][&#39;1&#39;] = [x*y for x,y in zip(iso_data[&#39;1&#39;], xs_data)]</span>
        
    <span class="c1">#   self._iso_xs_data = iso_xs_data</span>

    <span class="k">def</span> <span class="nf">_set_sampled_isomeric_branching_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">***********Sampling isomeric branching data***********</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">isomeric_branching_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read_isomeric_data</span><span class="p">()</span>
        <span class="n">sampled_isomeric_branching_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">nucl</span> <span class="ow">in</span> <span class="n">isomeric_branching_data</span><span class="p">:</span>
            <span class="n">nucl_data</span> <span class="o">=</span> <span class="n">isomeric_branching_data</span><span class="p">[</span><span class="n">nucl</span><span class="p">]</span>

            <span class="c1"># print (nucl_data[&#39;0&#39;])</span>
            <span class="n">sampled_isomeric_branching_data</span><span class="p">[</span><span class="n">nucl</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sampled_isomeric_branching_data</span><span class="p">[</span><span class="n">nucl</span><span class="p">][</span><span class="s1">&#39;0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nucl_data</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">mg_energy_mid_points</span><span class="p">)</span>
            <span class="n">sampled_isomeric_branching_data</span><span class="p">[</span><span class="n">nucl</span><span class="p">][</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nucl_data</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">mg_energy_mid_points</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_isomeric_branching_data</span> <span class="o">=</span> <span class="n">sampled_isomeric_branching_data</span>

    <span class="c1"># This method reads and samples the point-wise cross section for ng of the nuclides that</span>
    <span class="c1"># have ng isomeric branching data only</span>
    <span class="k">def</span> <span class="nf">_set_sampled_ng_cross_section_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">***********Sampling point-wise cross section data***********</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sampled_isomeric_branching_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_isomeric_branching_data</span>
        <span class="n">sampled_ng_cross_section_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cross_section_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cross_sections_path</span>
        <span class="n">cross_sections_files_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cross_section_path</span><span class="p">)</span>

        <span class="n">total_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">file_name_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">cross_sections_files_name</span><span class="p">:</span>
            <span class="n">nucl_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nucl_name</span> <span class="ow">in</span> <span class="n">sampled_isomeric_branching_data</span><span class="p">:</span>
                <span class="n">total_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">file_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_name_list</span><span class="p">:</span>
            <span class="n">nucl_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_few_isomeric</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nucl_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Pm147&#39;</span><span class="p">,</span> <span class="s1">&#39;Am241&#39;</span><span class="p">]:</span> <span class="c1"># make it a shorter</span>
                    <span class="n">nucl_path</span> <span class="o">=</span> <span class="n">cross_section_path</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                    <span class="n">xs_data</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">IncidentNeutron</span><span class="o">.</span><span class="n">from_hdf5</span><span class="p">(</span><span class="n">nucl_path</span><span class="p">)</span>
                    <span class="n">ng_xs_data</span> <span class="o">=</span> <span class="n">xs_data</span><span class="p">[</span><span class="mi">102</span><span class="p">]</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="n">xs_data</span><span class="o">.</span><span class="n">temperatures</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;--- Sampling </span><span class="si">{}</span><span class="s1"> (n,gamma) point-wise cross section --- [</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nucl_name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">total_count</span><span class="p">))</span>
                    <span class="n">sampled_ng_xs_data</span> <span class="o">=</span> <span class="n">ng_xs_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mg_energy_mid_points</span><span class="p">)</span>
                    <span class="n">sampled_ng_cross_section_data</span><span class="p">[</span><span class="n">nucl_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_ng_xs_data</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_few_isomeric</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span>
                <span class="n">nucl_path</span> <span class="o">=</span> <span class="n">cross_section_path</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">xs_data</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">IncidentNeutron</span><span class="o">.</span><span class="n">from_hdf5</span><span class="p">(</span><span class="n">nucl_path</span><span class="p">)</span>
                <span class="n">ng_xs_data</span> <span class="o">=</span> <span class="n">xs_data</span><span class="p">[</span><span class="mi">102</span><span class="p">]</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="n">xs_data</span><span class="o">.</span><span class="n">temperatures</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;--- Sampling </span><span class="si">{}</span><span class="s1"> (n,gamma) point-wise cross section --- [</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nucl_name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">total_count</span><span class="p">))</span>
                <span class="n">sampled_ng_xs_data</span> <span class="o">=</span> <span class="n">ng_xs_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mg_energy_mid_points</span><span class="p">)</span>
                <span class="n">sampled_ng_cross_section_data</span><span class="p">[</span><span class="n">nucl_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_ng_xs_data</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>  
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Time to sample cross sections: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_ng_cross_section_data</span> <span class="o">=</span> <span class="n">sampled_ng_cross_section_data</span>

    <span class="k">def</span> <span class="nf">_set_tallies_to_bucells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">bucell_dict</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">bucell_dict</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statepoint</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated_summary</span>
        <span class="n">xs_mode</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs_mode</span>
        <span class="n">sampled_isomeric_branching_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_isomeric_branching_data</span>
        <span class="n">sampled_ng_cross_section_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_ng_cross_section_data</span>

        <span class="k">for</span> <span class="n">bucell_id</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">bucell_id</span><span class="p">]</span>

            <span class="c1"># densities from OpenMC are extracted</span>
            <span class="c1"># This is for nuclides which are zero in onix but set to 1E-24 in OpenMC</span>
            <span class="c1"># 1E-24 fraction percent does not translate into 1E-24 atm/cm3 always</span>
            <span class="c1"># Therefore, the code needs to divide the reaction rate by the correct densities</span>
            <span class="c1"># taken from summary.geometry.cell.material</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_cells_by_name</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">material_dict</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get_all_materials</span><span class="p">()</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">material_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">material_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">mc_nuclides_densities</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">get_nuclide_atom_densities</span><span class="p">()</span>

            <span class="n">flux_tally</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> flux&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">flux_spectrum_tally</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> flux spectrum&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">rxn_rate_tally</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> rxn rate&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="c1"># H3_rxn_rate_tally = sp.get_tally(name = &#39;{} H3 rxn rate&#39;.format(bucell.name))</span>
            <span class="n">bucell</span><span class="o">.</span><span class="n">_set_MC_tallies</span><span class="p">(</span><span class="n">mc_nuclides_densities</span><span class="p">,</span> <span class="n">flux_tally</span><span class="p">,</span> <span class="n">flux_spectrum_tally</span><span class="p">,</span> <span class="n">rxn_rate_tally</span><span class="p">,</span> <span class="n">sampled_isomeric_branching_data</span><span class="p">,</span> <span class="n">sampled_ng_cross_section_data</span><span class="p">,</span> <span class="n">xs_mode</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="c1"># YOU NEED TO CREATE LIST TO STORE EACH NEW XS</span>

    <span class="c1"># Normalize the flux in each cell with the FMF after each openmc calculation</span>
    <span class="c1"># Calculate the power of each cell from the normalized flux</span>
    <span class="k">def</span> <span class="nf">_step_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
        <span class="n">master_bucell</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">master_bucell</span>
        <span class="k">if</span> <span class="n">master_bucell</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">FMF</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">_get_system_FMF</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FMF</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">_get_bucell_FMF</span><span class="p">(</span><span class="n">master_bucell</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="n">bucell_list</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_bucell_list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bucell</span> <span class="ow">in</span> <span class="n">bucell_list</span><span class="p">:</span>
            <span class="n">bucell_sequence</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">sequence</span>
            <span class="n">MC_flux</span> <span class="o">=</span> <span class="n">bucell_sequence</span><span class="o">.</span><span class="n">current_MC_flux</span>
            <span class="c1"># MC_flux is volume integrated (unit cm.sp</span>
            <span class="c1"># FMF is in sp.s</span>
            <span class="c1"># to have flux in cm.s you need to divide by volule of the cell</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">FMF</span><span class="o">*</span><span class="n">MC_flux</span><span class="o">/</span><span class="n">bucell</span><span class="o">.</span><span class="n">vol</span>
            <span class="n">pow_dens</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">_update_pow_dens</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">bucell_sequence</span><span class="o">.</span><span class="n">_set_macrostep_flux</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">bucell_sequence</span><span class="o">.</span><span class="n">_set_macrostep_pow_dens</span><span class="p">(</span><span class="n">pow_dens</span><span class="p">)</span>

    <span class="c1"># Normalize the flux in each cell with the FMF after each openmc calculation</span>
    <span class="c1"># Calculate the power of each cell from the normalized flux</span>
    <span class="c1"># This method seems obsolete</span>
    <span class="k">def</span> <span class="nf">initial_couple_step_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norma_mode</span><span class="p">):</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
        <span class="n">FMF</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">_get_FMF1</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">bucell_list</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_bucell_list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bucell</span> <span class="ow">in</span> <span class="n">bucell_list</span><span class="p">:</span>
            <span class="n">bucell_sequence</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">sequence</span>
            <span class="n">MC_flux</span> <span class="o">=</span> <span class="n">bucell_sequence</span><span class="o">.</span><span class="n">current_MC_flux</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">FMF</span><span class="o">*</span><span class="n">MC_flux</span>
            <span class="n">pow_dens</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">_update_pow_dens</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">bucell_sequence</span><span class="o">.</span><span class="n">_set_initial_flux</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
            <span class="n">bucell_sequence</span><span class="o">.</span><span class="n">_set_initial_pow_dens</span><span class="p">(</span><span class="n">pow_dens</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_MC_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">final</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="n">step_folder</span> <span class="o">=</span> <span class="s1">&#39;/step_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">final</span> <span class="o">==</span><span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="c1"># If it is the final step, sequence has not been requested to create</span>
            <span class="c1"># a step_final folder. This function needs to do it now.</span>
            <span class="n">final_step_path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gen_folder</span><span class="p">(</span><span class="s1">&#39;step_final&#39;</span><span class="p">)</span>
            <span class="n">step_folder</span> <span class="o">=</span> <span class="s1">&#39;/step_final&#39;</span>

        <span class="n">openmc_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">step_folder</span><span class="o">+</span><span class="s1">&#39;/OpenMC&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">openmc_file_path</span><span class="p">)</span>

        <span class="n">all_MC_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.xml&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;tallies.out&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.h5&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">all_MC_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">),</span> <span class="n">openmc_file_path</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">all_MC_files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_change_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

        <span class="c1"># It seems that temperature set in cells trumps the temperature set in material</span>
        <span class="c1"># Therefore, this method change temperature in cell</span>

        <span class="n">root_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_cell</span>
        <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">root_cell</span><span class="o">.</span><span class="n">get_all_cells</span><span class="p">()</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
        <span class="n">temperature_change_dict</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">temperature_change_dict</span>
        <span class="k">if</span> <span class="n">temperature_change_dict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cell_dict</span><span class="p">:</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">temperature_change_dict</span><span class="p">:</span>
                    <span class="n">cell_temperature_change</span> <span class="o">=</span> <span class="n">temperature_change_dict</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cell_temperature_change</span><span class="p">:</span>
                        <span class="n">new_temperature</span> <span class="o">=</span> <span class="n">cell_temperature_change</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                        <span class="n">cell</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">new_temperature</span>


    <span class="k">def</span> <span class="nf">_set_dens_to_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_summary</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">bucell_dict</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">bucell_dict</span>
        <span class="k">for</span> <span class="n">bucell_id</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">bucell_id</span><span class="p">]</span>
            <span class="n">tally_nucl_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mc_namelist_to_bu_namelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_nucl_to_be_tallied</span><span class="p">(</span><span class="n">bucell</span><span class="p">))</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_cells_by_name</span><span class="p">(</span><span class="n">bucell</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">material_dict</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get_all_materials</span><span class="p">()</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">material_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">material_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="c1">### WARNING Openmc add_nuclide in atom percent is not in absolute atom percent</span>
            <span class="c1">### but in relative ao, i.e., setting U235 and U238 to 0.34 and 0.34 will be the same</span>
            <span class="c1">### as setting them to 50% and 50 %</span>
            <span class="c1">### Therefore the ao value that needs to be updated needs to be normalize by the tot dens of</span>
            <span class="c1">### only the nuclides to be tallied and not by the total dens of all nuclide in bucell</span>
            <span class="n">tally_nucl_list_dens</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">_get_subtotal_dens_counting_zero_dens</span><span class="p">(</span><span class="n">tally_nucl_list</span><span class="p">)</span>
            <span class="n">material</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="s1">&#39;atom/b-cm&#39;</span><span class="p">,</span> <span class="n">tally_nucl_list_dens</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">nucl</span> <span class="ow">in</span> <span class="n">tally_nucl_list</span><span class="p">:</span>
                <span class="n">openmc_nucl_name</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">onix_name_to_openmc_name</span><span class="p">(</span><span class="n">nucl</span><span class="p">)</span>
                <span class="n">material</span><span class="o">.</span><span class="n">remove_nuclide</span><span class="p">(</span><span class="n">openmc_nucl_name</span><span class="p">)</span> 
                <span class="c1"># No need to calculate ao, just directly give density</span>
                <span class="c1">#nucl_subao = bucell.get_nucl_subao(nucl, tally_nucl_list)</span>
                <span class="n">nucl_dens</span> <span class="o">=</span> <span class="n">bucell</span><span class="o">.</span><span class="n">_get_nucl_dens_for_openmc</span><span class="p">(</span><span class="n">nucl</span><span class="p">)</span>
                <span class="n">material</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">openmc_nucl_name</span><span class="p">,</span> <span class="n">nucl_dens</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_MC_XS_nuc_list_to_bucells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">bucell_dict</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">bucell_dict</span>
        <span class="n">MC_XS_nucl_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span>
        <span class="n">MC_XS_nucl_list_obu_name</span> <span class="o">=</span>  <span class="n">utils</span><span class="o">.</span><span class="n">mc_namelist_to_bu_namelist</span><span class="p">(</span><span class="n">MC_XS_nucl_list</span><span class="p">)</span>
        <span class="n">MC_XS_nucl_list_zamid</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">name_list_to_zamid_list</span><span class="p">(</span><span class="n">MC_XS_nucl_list_obu_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bucell_id</span> <span class="ow">in</span> <span class="n">bucell_dict</span><span class="p">:</span>
            <span class="n">bucell</span> <span class="o">=</span> <span class="n">bucell_dict</span><span class="p">[</span><span class="n">bucell_id</span><span class="p">]</span>
            <span class="n">bucell</span><span class="o">.</span><span class="n">MC_XS_nucl_list</span> <span class="o">=</span> <span class="n">MC_XS_nucl_list_zamid</span>


<div class="viewcode-block" id="Couple_openmc.burn"><a class="viewcode-back" href="../../../pythonapi/generated/onix.couple.Couple_openmc.html#onix.couple.Couple_openmc.burn">[docs]</a>    <span class="k">def</span> <span class="nf">burn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Launches the coupled simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># If no decay libs have been set, set default libs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_set</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_default_decay_lib</span><span class="p">()</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">----  Default decay constants library set for system  ----</span><span class="se">\n</span><span class="s1">---- </span><span class="si">{}</span><span class="s1"> ----&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">default_decay_b_lib_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">----  User defined path for decay library  ----</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;----  </span><span class="si">{}</span><span class="s1">  ----</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_decay_lib_path</span><span class="p">))</span>
        

        <span class="c1"># If user has not set a fission yield library, default library (ENDF/B-VII.O) is set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_fy_lib_set</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_default_fy_lib</span><span class="p">()</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">----  Default fission yields library set for system  ----</span><span class="se">\n</span><span class="s1">---- </span><span class="si">{}</span><span class="s1"> ----&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">default_fy_lib_path</span><span class="p">))</span>
        
        <span class="c1"># If user has set a fission library, two options:</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_fy_lib_set</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">----  User defined path for fission yields library ----</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;----  </span><span class="si">{}</span><span class="s1">  ----</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_fy_lib_path</span><span class="p">))</span>

            <span class="c1"># 1) Default library used to complete user library</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_user_fy_lib</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">----  User defined fission yields library completed with default fission yields library ----</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;----  </span><span class="si">{}</span><span class="s1">  ----</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">default_fy_lib_path</span><span class="p">))</span>

            <span class="c1"># 2) Default library is not used, ONIX only uses user defined fission yields library</span>

        <span class="c1"># self.set_default_fy_lib()</span>
        <span class="c1"># print (&#39;\n\n\n----  Default fission yields library set for system  ----\n---- {} ----&#39;.format(data.default_fy_lib_path))</span>
        <span class="c1"># # If user has provided own fission yield library, data from this library extand and overwrite default library</span>
        <span class="c1"># if self._user_fy_lib_set == &#39;yes&#39;:</span>
        <span class="c1">#   print (&#39;\n\n\n----  User defined path for fission yields library ----\n\n&#39;)</span>
        <span class="c1">#   print (&#39;----  {}  ----\n\n\n&#39;.format(self._fy_lib_path))</span>
        
        <span class="c1">#print (self.xs_mode, self._xs_lib_set)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs_mode</span> <span class="o">==</span> <span class="s1">&#39;constant lib&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xs_lib_set</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_default_xs_lib</span><span class="p">()</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">----Default cross section library set for system----</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This method simply passes the MC_XS_nucl_list to each cell so that each cell</span>
            <span class="c1"># can then build its own lib_nucl_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_MC_XS_nuc_list_to_bucells</span><span class="p">()</span>

            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">----  Path for cross sections library ----</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;----  </span><span class="si">{}</span><span class="s1">  ----</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cross_sections_path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_sampled_isomeric_branching_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_sampled_ng_cross_section_data</span><span class="p">()</span>



        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">sequence</span>
        <span class="n">norma_mode</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">norma_unit</span>

        <span class="n">bucell_list</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_bucell_list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bucell</span> <span class="ow">in</span> <span class="n">bucell_list</span><span class="p">:</span>
            <span class="c1"># Check if different nuclide list (initial list, lib list and nucl set (user defined set of nuclides to be considered))</span>
            <span class="c1"># are consistent with each other</span>
            <span class="n">bucell</span><span class="o">.</span><span class="n">_check_nucl_list_consistency</span><span class="p">()</span>

            <span class="c1"># Create a list of all nuclides that should be produced, i.e., that belong to the network tree</span>
            <span class="c1">#bucell._reduce_nucl_set()</span>


        <span class="c1"># This should be somewhere else but for now it is done here</span>
        <span class="n">system</span><span class="o">.</span><span class="n">zam_order_passlist</span><span class="p">()</span>

        <span class="c1">#steps_number = sequence.steps_number</span>
        <span class="n">steps_number</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">macrosteps_number</span>
        <span class="c1"># Shift loop from 1 in order to align loop s and step indexes</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps_number</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n\n</span><span class="s1">====== STEP </span><span class="si">{}</span><span class="s1">======</span><span class="se">\n\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">_gen_step_folder</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">((</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">=== OpenMC Transport </span><span class="si">{}</span><span class="s1">===</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_change_temperature</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_openmc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_tallies_to_bucells</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_normalization</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_MC_files</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">((</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">=== Salameche Burn </span><span class="si">{}</span><span class="s1"> ===</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">salameche_header</span><span class="p">)</span>
            <span class="n">salameche</span><span class="o">.</span><span class="n">burn_step</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;couple&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dens_to_cells</span><span class="p">()</span>
        
        <span class="c1"># This last openmc_run is used to compute the last burnup/time point kinf</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">=== OpenMC Transport for Final Point ===</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_openmc</span><span class="p">()</span>

        <span class="n">system</span><span class="o">.</span><span class="n">_gen_output_summary_folder</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reac_rank</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_allreacs_rank</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_subdens</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_dens</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_xs</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_flux_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mg_energy</span><span class="p">)</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_kinf</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_param</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_print_summary_isomeric_branching_ratio</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_MC_files</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>

        <span class="n">run_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1"> &gt;&gt;&gt;&gt;&gt;&gt; ONIX burn took </span><span class="si">{}</span><span class="s1"> seconds &lt;&lt;&lt;&lt;&lt;&lt;&lt; </span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_time</span><span class="p">))</span></div></div>

<span class="k">class</span> <span class="nc">Initial_nuclides_not_in_nuclide_list</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise when some initial nuclides are not included in nucl_list &quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">STOP</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Just a way to stop the code&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Julien de Troullioud de Lanversin

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30411614-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</body>
</html>